'use strict';function ModelRealtimeProvider($filter,$log,ModelNotifier,ModelWebSocket,ModelRealtimeObserver,VtgProcessingComponents,FilterToNumberOrNullFilter,FilterIsTradeWithinCoreHoursFilter,FilterIsTickWithinCoreHoursFilter){var toNumberOrNull=FilterToNumberOrNullFilter;var isTradeWithinCoreHours=FilterIsTradeWithinCoreHoursFilter;var isTickWithinCoreHours=FilterIsTickWithinCoreHoursFilter;var savedTicks=[];var securitiesData={};var gridData=[];var includeTrades=true;var socketReady=false;var notifier=ModelNotifier.createNotifier();var noSecurities=true;var currentIdentifiers='';var requestedSecurities;var requestedSecuritiesById={};var waitForInitvalueResponse=true;var getSecurityId=$filter('VntgIdentifierFromAvailable');var filterRealtimeProviderItem=$filter('FilterRealtimeProviderItem');function setSecurities(securities){var socketRequests=VtgProcessingComponents.websocket;requestedSecurities=getSecurities(securities);requestedSecuritiesById=$filter('VntgAvailableIdentifiers')(requestedSecurities);noSecurities=requestedSecurities.length===0;broadcastIdentifiers();var requestRequired=!socketReady||socketRequests!==VtgProcessingComponents.websocket;if(!requestRequired){notifier.publish('create',getGridData());}
else{securitiesData={};gridData=[];waitForInitvalueResponse=true;}}
function getSecurities(newSecurities){var resultSecurities=[];if(!newSecurities){return resultSecurities;}
var currentItem;var currentItemId;for(var i=0;i<newSecurities.length;i++){currentItem=newSecurities[i];currentItemId=(currentItem.security&&currentItem.security.id)||currentItem.id||currentItem.identifier;if(!currentItemId){console.log('cant get item id '+JSON.stringify(currentItem));continue;}
var resultItem={identifier:currentItemId};if(securitiesData&&securitiesData[currentItemId]){resultItem=angular.extend(securitiesData[currentItemId],currentItem,resultItem);}
resultSecurities.push(resultItem);}
return resultSecurities;}
function broadcastIdentifiers(){function prepareIdentifiers(inData){var securities=[];angular.forEach(inData,function(item){if($filter('VtgArrayIndexOf')(securities,item.identifier)===-1){securities.push(item.identifier);}});securities.sort();return securities;}
if(!socketReady||noSecurities){return;}
var ids=prepareIdentifiers(requestedSecurities);var asOfDate=new Date().getTime();var newIdentifiers=ids.join();if(newIdentifiers!==currentIdentifiers){VtgProcessingComponents.websocket++;ModelWebSocket.emit('br.watch',{identifiers:ids,asOfDate:asOfDate,includeTrades:includeTrades});currentIdentifiers=newIdentifiers;}}
function addDataFor(identifier,data){var newItem=filterRealtimeProviderItem({});newItem.identifier=identifier;if(data.gnd_timezone||data.timezone){newItem.gnd_timezone=getTimezone(data);}
if(data.coreStart){newItem.coreStart=data.coreStart;}
if(data.coreEnd){newItem.coreEnd=data.coreEnd;}
securitiesData[identifier]=newItem;gridData.push(newItem);}
function getTimezone(data){if(data){return data.gnd_timezone?data.gnd_timezone:data.timezone;}else{return null;}}
function updateTick(data){var identifier=getSecurityId(data,requestedSecuritiesById);if(!identifier){return;}
if(!securitiesData[identifier]){addDataFor(identifier,data);}
var securityData=securitiesData[identifier];var coreStart=toNumberOrNull(securityData.coreStart);var coreEnd=toNumberOrNull(securityData.coreEnd);var timezone=securityData.gnd_timezone;if(!isTickWithinCoreHours(data,coreStart,coreEnd,timezone)){return;}
var newTickTime=toNumberOrNull(data.t);var oldTickTime=toNumberOrNull(securityData.t);if(oldTickTime&&newTickTime&&(newTickTime<oldTickTime)){return;}
if(!waitForInitvalueResponse){var oldData={bid_price:securityData.bid_price,bid_yield:securityData.bid_yield,bid_spread:securityData.bid_spread,px_chg:securityData.px_chg,volume:securityData.volume,count:securityData.count};}
var count=toNumberOrNull(data.count,securityData.count);var volume=toNumberOrNull(data.volume,securityData.volume);angular.extend(securityData,data);securityData.count=count;securityData.volume=volume;securityData.identifier=identifier;if(!noSecurities&&!waitForInitvalueResponse){notifier.publish('updateTick',securityData,oldData);}}
function updateTrade(data){var identifier=getSecurityId(data,requestedSecuritiesById);if(!identifier){return;}
if(!securitiesData[identifier]){addDataFor(identifier,data);}
var securityData=securitiesData[identifier];if(!waitForInitvalueResponse){var oldData={ltPrice:securityData.ltPrice,ltSize:securityData.ltSize,ltSide:securityData.ltSide,ltTime:securityData.ltTime};}
securityData.ltPrice=data.price;securityData.ltSize=data.size||data.par||(data.indic_par=='MM+'?5000001:null);securityData.ltSide=data.side;securityData.ltTime=data.time;securityData.ltDelay=data.delay;if(!noSecurities&&!waitForInitvalueResponse){notifier.publish('updateTrade',securityData,oldData);}}
function getSecuritiesData(){return noSecurities?{}:securitiesData;}
function getGridData(){return noSecurities?[]:gridData;}
function setIncludeTrades(value){includeTrades=value;}
ModelRealtimeObserver.subscribe(['sv.trade'],function(msg,data){updateTrade(data);});ModelRealtimeObserver.subscribe(['sv.tick'],function(msg,data){if(waitForInitvalueResponse){savedTicks.push(data);return;}
updateTick(data);});ModelRealtimeObserver.subscribe(['sv.initvalue'],function(msg,data){if(data&&data.ticks){angular.forEach(data.ticks,function(currentItem){if(currentItem===null){return;}
updateTick(currentItem);});}
angular.forEach(savedTicks,updateTick);savedTicks=[];if(data&&data.trades){angular.forEach(data.trades,function(currentItem){if(currentItem===null){return;}
updateTrade(currentItem);});}
waitForInitvalueResponse=false;notifier.publish('create',getGridData());});ModelRealtimeObserver.setCheckHoursRange(false);ModelRealtimeObserver.subscribe(["sv.get.watch"],function(){socketReady=true;broadcastIdentifiers();});return{getSecuritiesData:getSecuritiesData,getGridData:getGridData,setSecurities:setSecurities,setIncludeTrades:setIncludeTrades,subscribe:notifier.subscribe,unsubscribe:notifier.unsubscribe};}
angular.module('ModuleRealtime').filter('VntgIdentifierFromAvailable',function(FilterRealtimeUndefinedToNullFilter){return function(data,availableIdentifiers){if(!data){return undefined;}
if(angular.isObject(data)){return FilterRealtimeUndefinedToNullFilter(data.identifier&&availableIdentifiers[data.identifier],data.isin&&availableIdentifiers[data.isin],data.cusip&&availableIdentifiers[data.cusip],data.sedol&&availableIdentifiers[data.sedol]);}
return FilterRealtimeUndefinedToNullFilter(data&&availableIdentifiers[data]);};});angular.module('ModuleRealtime').filter('VntgAvailableIdentifiers',function(){return function(securities){var result={};angular.forEach(securities,function(item){var identifier=angular.isObject(item)?item.identifier||item.id:item||'';if(identifier.length===9){result[identifier.slice(0,8)]=identifier;}
result[identifier]=identifier;});return result;};});angular.module('ModuleRealtime').service('ModelRealtimeProvider',ModelRealtimeProvider);;"use strict";function ModelRealtimeMoversCnstns(){return{assetTypes:{ASSET_ALL:'ALL'},maturityTypes:{MAT_ALL:'ALL'},sortTypes:{TOP_PRICE_CHANGE:'TOP_PRICE_CHANGE',TOP_VOLUME:'TOP_VOLUME',TOP_TRADES:'TOP_TRADES'},sectorTypes:{SECTOR_ALL:'ALL'},listTypes:{LIST_ALL:'ALL'},ratingTypes:{RATING_ALL:34,RATING_AAA:33,RATING_AA_PLUS:32,RATING_AA:31,RATING_AA_MINUS:30,RATING_A_PLUS:29,RATING_A:28,RATING_A_MINUS:27,RATING_BBB_PLUS:26,RATING_BBB:25,RATING_BBB_MINUS:24,RATING_BB_PLUS:23,RATING_BB:22,RATING_BB_MINUS:21,RATING_B_PLUS:20,RATING_B:19,RATING_B_MINUS:18,RATING_CCC_PLUS:17,RATING_CCC:16,RATING_CCC_MINUS:15,RATING_CC_PLUS:14,RATING_CC:13,RATING_CC_MINUS:12,RATING_C_PLUS:11,RATING_C:10,RATING_C_MINUS:9,RATING_D:8,RATING_NR:7,RATING_WR:6,RATING_SD:5,RATING_AVERAGE:4,RATING_STRONG:3,RATING_UR:2,RATING_NA:1},resultListItems:{TOP_GAINERS_LOSERS_COUNT:10,TOP_VOLUME_COUNT:20,TOP_TRADES_COUNT:20},listPrefixes:{WATCH_LIST_PREFIX:'LIST_W_',PORTFOLIO_PREFIX:'LIST_P_'},RESORT_LIST_MS:1000,CONTACTS_MESSAGE:'Please call a Vantage representative at '+'+781-687-8383 from 07:30 to 18:00 (Eastern Time), Monday through Friday for more '+'information regarding the Gainers and Decliners page.'};}
angular.module('ModuleRealtime').service('ModelRealtimeMoversCnstns',ModelRealtimeMoversCnstns);;"use strict";function MoversListFactory($log,$filter,$timeout,MoversControlsSource,ModelRealtimeProvider,ModelNotifier,ModelHttp,ModelRealtimeObserver,ServiceModal,ModelRealtimeCnstnt,ModelRealtimeMoversCnstns,VtgProcessingComponents,ModelWebSocket,FilterRealtimeUniqueFilter,FilterToNumberOrNullFilter,FilterRealtimeUndefinedToNullFilter,FilterRealtimeProviderItemFilter,FilterRealtimeSecurityIdentifierFilter,FilterRealtimeTickFixNumbersFilter,VtgFormatIssueFilter){var getUniqueItems=FilterRealtimeUniqueFilter;var toNumberOrNull=FilterToNumberOrNullFilter;var toDefinedOrNull=FilterRealtimeUndefinedToNullFilter;var toRealtimeProviderItem=FilterRealtimeProviderItemFilter;var getWithIdentifier=FilterRealtimeSecurityIdentifierFilter;var fixTickDataNumbers=FilterRealtimeTickFixNumbersFilter;var getSecurityId=$filter('VntgIdentifierFromAvailable');var socketReadyProvider=createSocketReadyProvider();var realTimeProvider=ModelRealtimeProvider;var LIST_NOT_CHANGED=0;var LIST_CHANGED=1;var LIST_RECREATED=2;function getHeadersPositionIds(data){var result='';var items=0;for(var i=0;i<data.length;i++){if(data[i].gainersHeader){result+='g'+i;items=0;}
else if(data[i].losersHeader){if(items>0){result+='_'+items;}
result+='l'+i;items=0;}
items++;}
if(items>0){result+='_'+items;}
return result;}
function sortData(sortedData,srcData,moversType,sortColumnOptions){function getIds(data){var result='';if(!data){return result;}
angular.forEach(data,function(currentItem){result+=currentItem.identifier||'';});return result;}
if(!srcData||srcData.length===0){sortedData.length=0;return LIST_RECREATED;}
var itemsBefore=sortedData.length;var oldIds=getIds(sortedData);var result=LIST_NOT_CHANGED;switch(moversType){case ModelRealtimeMoversCnstns.sortTypes.TOP_PRICE_CHANGE:var headersPosition={};result=sortByPriceChange(sortedData,srcData,headersPosition);if(sortColumnOptions.column&&(sortColumnOptions.column!=='px_chg'||!sortColumnOptions.desc)){if(angular.isNumber(headersPosition.gainers)){sortByColumn(sortedData,headersPosition.gainers+1,headersPosition.losers||sortedData.length,sortColumnOptions);}
if(angular.isNumber(headersPosition.losers)){var losersOptions=angular.copy(sortColumnOptions);if(sortColumnOptions.column==='px_chg'){losersOptions.desc=losersOptions.desc?false:true;}
sortByColumn(sortedData,headersPosition.losers+1,sortedData.length,losersOptions);}}
break;case ModelRealtimeMoversCnstns.sortTypes.TOP_TRADES:result=sortByTrades(sortedData,srcData);if(sortColumnOptions.column&&(sortColumnOptions.column!=='count'||!sortColumnOptions.desc)){sortByColumn(sortedData,0,srcData.length,sortColumnOptions);}
break;case ModelRealtimeMoversCnstns.sortTypes.TOP_VOLUME:result=sortByVolume(sortedData,srcData);if(sortColumnOptions.column&&(sortColumnOptions.column!=='volume'||!sortColumnOptions.desc)){sortByColumn(sortedData,0,srcData.length,sortColumnOptions);}
break;}
var newIds=getIds(sortedData);var itemsAfter=sortedData.length;if(itemsAfter!==itemsBefore){result=LIST_RECREATED;}
else if(newIds!==oldIds){result=Math.max(result,LIST_CHANGED);}
return result;}
function compareAsNumbers(column){return function(lhs,rhs){return(parseFloat(lhs[column])||0)-(parseFloat(rhs[column])||0);};}
function compareAsStrings(column){function toStr(value){return value===undefined||value===null?'':''+value;}
return function(lhs,rhs){return toStr(lhs[column]).localeCompare(toStr(rhs[column]));};}
function compareIssues(lhs,rhs){return VtgFormatIssueFilter(lhs).localeCompare(VtgFormatIssueFilter(rhs));}
function compareSectors(lhs,rhs){var lhsSector=MoversControlsSource.getSectorName(lhs.sectorId)||'';var rhsSector=MoversControlsSource.getSectorName(rhs.sectorId)||'';return lhsSector.localeCompare(rhsSector);}
function compareMaturities(){var maturityScore={'Short':0.5,'1Y':1,'1Yr':1,'2Y':2,'2Yr':2,'3Y':3,'3Yr':3,'5Y':5,'5Yr':5,'7Y':7,'7Yr':7,'10Y':10,'10Yr':10,'30Y':30,'30Yr':30,'Perpetual':0};return function(lhs,rhs){return(maturityScore[lhs.maturity]||-1)-(maturityScore[rhs.maturity]||-1)};}
function compareTradeTypes(){var tradeTypeScores={B:1,D:2,S:3,N:4};function getTradeTypeScore(item){return tradeTypeScores[item.ltSide||'N']||0;}
return function(lhs,rhs){return getTradeTypeScore(lhs)-getTradeTypeScore(rhs);};}
var columnsComparers={bid_price:compareAsNumbers('bid_price'),px_chg:compareAsNumbers('px_chg'),t:compareAsNumbers('t'),ltTime:compareAsNumbers('ltTime'),ltPrice:compareAsNumbers('ltPrice'),ltSize:compareAsNumbers('ltSize'),ltSide:compareTradeTypes(),count:compareAsNumbers('count'),volume:compareAsNumbers('volume'),coupon:compareIssues,sectorId:compareSectors,spRating:compareAsNumbers('spRating'),maturity:compareMaturities()};function sortByColumn(sortedData,begin,end,sortColumnOptions){var toSort=sortedData.slice(begin,end);var rowId=sortedData[begin].rowId;var column=sortColumnOptions.column;var compareFunc=columnsComparers[column]||compareAsStrings(column);toSort.sort(function(lhs,rhs){var result=compareFunc(lhs,rhs)||lhs.identifier.localeCompare(rhs.identifier)||(lhs._stablePosition-rhs._stablePosition);return sortColumnOptions.desc?-result:result;});angular.forEach(toSort,function(item){item.rowId=rowId++;});Array.prototype.splice.apply(sortedData,[begin,end-begin].concat(toSort));}
function sortByPriceChange(sortedData,srcData,headersPosition){function fixedPxChg(pxChg){return angular.isNumber(pxChg)?pxChg:-1e-15;}
var gainersOrLosersCount=ModelRealtimeMoversCnstns.resultListItems.TOP_GAINERS_LOSERS_COUNT,oldHeadersPosition=getHeadersPositionIds(sortedData),index,lastGainerIndex=-1,firstLoserIndex=srcData.length,rowId=1;sortedData.length=0;if(srcData.length===0){return LIST_NOT_CHANGED;}
srcData.sort(function(lhs,rhs){return(fixedPxChg(rhs.px_chg)-fixedPxChg(lhs.px_chg))||rhs.identifier.localeCompare(lhs.identifier)||(lhs._stablePosition-rhs._stablePosition);});if(srcData[0].px_chg>=0){headersPosition.gainers=rowId-1;sortedData.push({gainersHeader:true,rowId:rowId++,issuer:'Top Gainers by Price Change'});}
for(index=0;index<gainersOrLosersCount;index++){if(!srcData[index]||fixedPxChg(srcData[index].px_chg)<0){break;}
var gainerItem=srcData[index];gainerItem._stablePosition=index;gainerItem.rowId=rowId++;sortedData.push(gainerItem);lastGainerIndex=index;}
if(fixedPxChg(srcData[srcData.length-1].px_chg)<0){headersPosition.losers=rowId-1;sortedData.push({losersHeader:true,rowId:rowId++,issuer:'Top Decliners by Price Change'});}
for(index=srcData.length-1;index>=srcData.length-gainersOrLosersCount;index--){if(!srcData[index]||fixedPxChg(srcData[index].px_chg)>=0){break;}
var loserItem=srcData[index];loserItem._stablePosition=index;loserItem.rowId=rowId++;sortedData.push(loserItem);firstLoserIndex=index;}
for(index=lastGainerIndex+1;index<firstLoserIndex;index++){var hiddenItem=srcData[index];hiddenItem._stablePosition=index;hiddenItem.rowId=-1;}
var newHeadersPosition=getHeadersPositionIds(sortedData);return newHeadersPosition!==oldHeadersPosition?LIST_RECREATED:LIST_NOT_CHANGED;}
function sortByTrades(sortedData,srcData){var index,currentItem;sortedData.length=0;if(srcData.length===0){return LIST_NOT_CHANGED;}
srcData.sort(function(lhs,rhs){return((rhs.count||0)-(lhs.count||0))||rhs.identifier.localeCompare(lhs.identifier)||(lhs._stablePosition-rhs._stablePosition);});for(index=0;index<srcData.length;index++){currentItem=srcData[index];currentItem._stablePosition=index;if(index<ModelRealtimeMoversCnstns.resultListItems.TOP_TRADES_COUNT){sortedData.push(currentItem);currentItem.rowId=index;}
else{currentItem.rowId=-1;}}
return LIST_NOT_CHANGED;}
function sortByVolume(sortedData,srcData){var index,currentItem;sortedData.length=0;if(srcData.length===0){return LIST_NOT_CHANGED;}
srcData.sort(function(lhs,rhs){return((rhs.volume||0)-(lhs.volume||0))||rhs.identifier.localeCompare(lhs.identifier)||(lhs._stablePosition-rhs._stablePosition);});for(index=0;index<srcData.length;index++){currentItem=srcData[index];currentItem._stablePosition=index;if(index<ModelRealtimeMoversCnstns.resultListItems.TOP_VOLUME_COUNT){sortedData.push(currentItem);currentItem.rowId=index;}
else{currentItem.rowId=-1;}}
return LIST_NOT_CHANGED;}
function createSocketReadyProvider(){var socketReady=false;var notifier=ModelNotifier.createNotifier();ModelRealtimeObserver.subscribe(["sv.get.watch"],function(){socketReady=true;notifier.publish('ready');});function isReady(){return socketReady;}
return{isReady:isReady,subscribe:notifier.subscribe,unsubscribe:notifier.unsubscribe};}
function verifyGridData(gridData){function checkItem(item,field,predicate){if(!predicate(item[field])){console.log('The '+field+' field has wrong type: '+
typeof item[field]+'; ('+item[field]+'); identifier: '+item.identifier);}}
function isNumberOrNull(item){return item===null||angular.isNumber(item);}
function isStringOrNull(item){return item===null||angular.isString(item);}
angular.forEach(gridData,function(gridItem){checkItem(gridItem,'rowId',angular.isNumber);if(gridItem.gainersHeader||gridItem.losersHeader){return;}
checkItem(gridItem,'assetType',isStringOrNull);checkItem(gridItem,'maturity',isStringOrNull);checkItem(gridItem,'issuer',isStringOrNull);checkItem(gridItem,'ticker',isStringOrNull);checkItem(gridItem,'coupon',isNumberOrNull);checkItem(gridItem,'maturityDate',angular.isDefined);checkItem(gridItem,'identifier',angular.isString);checkItem(gridItem,'bid_price',isNumberOrNull);checkItem(gridItem,'px_chg',isNumberOrNull);checkItem(gridItem,'t',isNumberOrNull);checkItem(gridItem,'ltPrice',isNumberOrNull);checkItem(gridItem,'ltSize',isNumberOrNull);checkItem(gridItem,'ltTime',isNumberOrNull);checkItem(gridItem,'ltSide',isStringOrNull);checkItem(gridItem,'count',isNumberOrNull);checkItem(gridItem,'volume',isNumberOrNull);checkItem(gridItem,'spRating',isNumberOrNull);checkItem(gridItem,'sectorId',isNumberOrNull);});}
function createGlobalListProvider(initOptions,initSortOptions,listResolver){var notifier=ModelNotifier.createNotifier();var options=initOptions;var sortOptions=initSortOptions;var socketRequests=0;var list={};var securitiesData={};var unsortedData=[];var gridData=[];var forceCreateEvent=true;var noSecurities=false;var deinitialized=false;var additionalInfoReceived=false;var svInitValueResponseReceived=false;var prevTopGainers=null;var prevTopLosers=null;var getAdditionalInfoAjaxRequest;var resortListPromise;var getListContentAjaxOperation;function listRequired(){return angular.isDefined(listResolver);}
function listContentReady(){return!listRequired()||list.securities;}
function initialize(){function initializeInternal(){socketReadyProvider.subscribe('ready',requestListByCriteria);ModelRealtimeObserver.subscribe(['sv.movers'],onListChanged);MoversControlsSource.subscribe('currenciesReady',requestListByCriteria);realTimeProvider.subscribe('updateTick',onDataUpdated);realTimeProvider.subscribe('updateTrade',onDataUpdated);realTimeProvider.setSecurities([]);realTimeProvider.subscribe('create',onDataCreated);requestListByCriteria();}
if(!listRequired()){initializeInternal();MoversControlsSource.setAvailableCurrencyIds([]);return;}
MoversControlsSource.setAvailableCurrencyIds(null);getListContentAjaxOperation=ModelHttp.ajaxOp({method:'GET',url:listResolver.serviceUrl(),callback:function(data){if(deinitialized){return;}
if(data&&data.status===ModelHttp.STATUS_ERROR&&data.msg){ServiceModal.show("Error",data.msg);return;}
if(!listResolver.isValidResponse(data)){ServiceModal.show("Error",ModelRealtimeCnstnt.Msg.ERROR_UNKNOWN,true);return;}
MoversControlsSource.setAvailableCurrencyIds(listResolver.getAvailableCurrencies(data));list=listResolver.getListFromResponse(data);list.requestedSecuritiesById=$filter('VntgAvailableIdentifiers')(list.securities);initializeInternal();}});}
function deinitialize(){deinitialized=true;MoversControlsSource.setAvailableCurrencyIds(null);socketReadyProvider.unsubscribe('ready',requestListByCriteria);ModelRealtimeObserver.unsubscribe('sv.movers',onListChanged);realTimeProvider.unsubscribe('updateTick',onDataUpdated);realTimeProvider.unsubscribe('updateTrade',onDataUpdated);realTimeProvider.unsubscribe('create',onDataCreated);VtgProcessingComponents.websocket=Math.max(VtgProcessingComponents.websocket-socketRequests,0);if(getAdditionalInfoAjaxRequest){getAdditionalInfoAjaxRequest.cancel();}
if(angular.isDefined(resortListPromise)){$timeout.cancel(resortListPromise);}
if(angular.isDefined(getListContentAjaxOperation)){getListContentAjaxOperation.cancel();}}
function getCriteriaFromOptions(){function copyFieldIfNotDefault(srcObject,dstObject,field,defaultValue){if(srcObject[field]!==defaultValue){dstObject[field]=srcObject[field];}}
var src=angular.copy(options);if(src.maturity!==ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL){src.maturity=MoversControlsSource.getMaturityName(src.maturity);}
if(src.spRating!==ModelRealtimeMoversCnstns.ratingTypes.RATING_ALL){src.spRating=MoversControlsSource.getSpRatingName(src.spRating);}
var currencies=[];angular.forEach(src.currencies,function(currency){if(MoversControlsSource.isCurrencyAvailable(currency)){currencies.push(currency);}});if((MoversControlsSource.allCurrencies&&MoversControlsSource.allCurrencies.length===currencies.length)||currencies.length===0){currencies=null;}
src.currencies=currencies;var criteriaOptions={};criteriaOptions.moversType=src.moversType;copyFieldIfNotDefault(src,criteriaOptions,'maturity',ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL);copyFieldIfNotDefault(src,criteriaOptions,'assetType',ModelRealtimeMoversCnstns.assetTypes.ASSET_ALL);copyFieldIfNotDefault(src,criteriaOptions,'sector',ModelRealtimeMoversCnstns.sectorTypes.SECTOR_ALL);copyFieldIfNotDefault(src,criteriaOptions,'spRating',ModelRealtimeMoversCnstns.ratingTypes.RATING_ALL);copyFieldIfNotDefault(src,criteriaOptions,'currencies',null);if(listRequired()){criteriaOptions.ids=list.securities;}
return criteriaOptions;}
var prevCriteriaOptions;function requestListByCriteria(){if(deinitialized||!socketReadyProvider.isReady()||!listContentReady()||!MoversControlsSource.currenciesReady){return;}
var criteriaOptions=getCriteriaFromOptions();if(angular.equals(prevCriteriaOptions,criteriaOptions)){return true;}
prevCriteriaOptions=angular.copy(criteriaOptions);noSecurities=false;ModelWebSocket.emit('br.movers.criteria',criteriaOptions);VtgProcessingComponents.websocket++;socketRequests++;}
function resortList(){resortListPromise=undefined;var createAction=sortData(gridData,unsortedData,options.moversType,sortOptions);if(createAction===LIST_RECREATED||forceCreateEvent){notifier.publish('create',gridData);forceCreateEvent=false;}else{notifier.publish('change',gridData);}}
function setSortOptions(newSortOptions){sortOptions=newSortOptions;if(svMoversResponsesReady()){resortList();}}
function identifierType(securityData){if(!securityData.identifier){return null;}
if(securityData.isin&&securityData.identifier===securityData.isin){return'isin';}
if(securityData.sedol&&securityData.identifier===securityData.sedol){return'sedol';}
if(securityData.cusip&&securityData.identifier.slice(0,8)===securityData.cusip.slice(0,8)){return'cusip';}
return null;}
function processAdditionalInfoItem(gridItem,srcItem){gridItem.ticker=toDefinedOrNull(srcItem.ticker,gridItem.ticker);gridItem.maturityDate=toDefinedOrNull(srcItem.maturity_date,srcItem.maturityDate,gridItem.maturityDate);gridItem.coupon=toNumberOrNull(srcItem.coupon,gridItem.coupon);gridItem.issuer=toDefinedOrNull(srcItem.issuer,gridItem.issuer);var optionsRating=options.spRating===ModelRealtimeMoversCnstns.ratingTypes.RATING_ALL?null:options.spRating;gridItem.spRating=toNumberOrNull(optionsRating,gridItem.spRating,MoversControlsSource.getSpRatingId(srcItem.rating),MoversControlsSource.getSpRatingId(srcItem.spRating),srcItem.spRating);var optionsSector=options.sector===ModelRealtimeMoversCnstns.sectorTypes.SECTOR_ALL?null:options.sector;gridItem.sectorId=toNumberOrNull(optionsSector,gridItem.sectorId,srcItem.sic_code,srcItem.sectorId);var optionsMaturity=options.maturity===ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL?null:options.maturity;gridItem.maturity=toDefinedOrNull(gridItem.maturity,MoversControlsSource.getMaturityId(srcItem.maturity),srcItem.maturity,optionsMaturity,MoversControlsSource.getMaturityId('Perpetual'));gridItem.bondId=toNumberOrNull(srcItem.bondId,gridItem.bondId);gridItem.assetType=toDefinedOrNull(gridItem.assetType,srcItem.assetType,srcItem.asset_class);gridItem.bondId=toDefinedOrNull(srcItem.bondId,gridItem.bondId);}
function processAdditionalInfo(data){if(deinitialized||!svMoversResponsesReady()||noSecurities){return;}
if(data&&data.status===ModelHttp.STATUS_ERROR&&data.msg){ServiceModal.show("Error",data.msg);return;}
if(!data||!data.securities){ServiceModal.show("Error",ModelRealtimeCnstnt.Msg.ERROR_UNKNOWN,true);return;}
angular.forEach(data.securities,function(currentItem){var identifier=listRequired()?getSecurityId(currentItem.id,list.requestedSecuritiesById):currentItem.id;var gridItem=securitiesData[identifier];if(gridItem){processAdditionalInfoItem(gridItem,currentItem);}else{}});additionalInfoReceived=true;resortList();}
function requestAdditionalInfo(securities){additionalInfoReceived=false;if(listRequired()){var additionalInfoData=listResolver.getAdditionalInfo();if(additionalInfoData){processAdditionalInfo(additionalInfoData);return;}}
if(getAdditionalInfoAjaxRequest){getAdditionalInfoAjaxRequest.cancel();}
var requestData={securities:[]};angular.forEach(securities,function(item){if(item.issuer){return;}
requestData.securities.push({id:item.identifier.length===9?item.identifier.slice(0,8):item.identifier,type:identifierType(item)});});if(requestData.securities.length===0){additionalInfoReceived=true;return;}
getAdditionalInfoAjaxRequest=ModelHttp.ajaxOp({method:'POST',url:'/movers/symbolinfo',data:requestData,callback:function(data){processAdditionalInfo(data);}});}
function svMoversResponsesReady(){if(options.moversType===ModelRealtimeMoversCnstns.sortTypes.TOP_PRICE_CHANGE){return!!(prevTopGainers&&prevTopLosers);}else{return!!prevTopGainers;}}
function onListChanged(msg,data){if(deinitialized||!listContentReady()){return;}
var topPriceChangeMode=options.moversType===ModelRealtimeMoversCnstns.sortTypes.TOP_PRICE_CHANGE;if(!topPriceChangeMode){delete data.topLosers;if(!data.topGainers){return;}}
data.topGainers=data.topGainers||prevTopGainers;data.topLosers=data.topLosers||prevTopLosers;prevTopGainers=angular.copy(data.topGainers);prevTopLosers=angular.copy(data.topLosers);if(!svMoversResponsesReady()){return;}
if(socketRequests>0){VtgProcessingComponents.websocket--;socketRequests--;}
var newSecuritiesData={};var allSecurities=data.topGainers.concat(data.topLosers||[]);angular.forEach(allSecurities,function(currentItem){currentItem=getWithIdentifier(currentItem);});allSecurities=getUniqueItems(allSecurities,'identifier');angular.forEach(allSecurities,function(item){item=fixTickDataNumbers(item);item=toRealtimeProviderItem(item);});noSecurities=!allSecurities.length;if(noSecurities){gridData=[];notifier.publish('create',topMoversGridData());return;}
angular.forEach(allSecurities,function(item){if(listRequired()){var originalIdentifier=getSecurityId(item,list.requestedSecuritiesById);item.identifier=originalIdentifier||item.identifier;}
if(securitiesData[item.identifier]){angular.extend(item,securitiesData[item.identifier]);}
processAdditionalInfoItem(item,item);newSecuritiesData[item.identifier]=item;});securitiesData=newSecuritiesData;unsortedData=allSecurities;resortList();svInitValueResponseReceived=false;realTimeProvider.setSecurities(allSecurities);requestAdditionalInfo(allSecurities);}
function onDataCreated(){var chooseNewestValue=function(newItem,oldItem,field){if(oldItem.t>newItem.t||newItem[field]===null){newItem[field]=toNumberOrNull(oldItem[field],newItem[field]);}};if(deinitialized||!listContentReady()||!svMoversResponsesReady()||noSecurities){return;}
var createdData=realTimeProvider.getSecuritiesData();var i;var currentItem;for(i=0;i<unsortedData.length;i++){currentItem=unsortedData[i];if(currentItem.gainersHeader||currentItem.losersHeader){continue;}
var securitiesCreatedData=createdData[currentItem.identifier];if(!securitiesCreatedData){continue;}
processAdditionalInfoItem(securitiesCreatedData,currentItem);chooseNewestValue(securitiesCreatedData,currentItem,'bid_price');chooseNewestValue(securitiesCreatedData,currentItem,'px_chg');chooseNewestValue(securitiesCreatedData,currentItem,'count');chooseNewestValue(securitiesCreatedData,currentItem,'volume');chooseNewestValue(securitiesCreatedData,currentItem,'t');unsortedData[i]=securitiesCreatedData;var identifier=listRequired()?getSecurityId(unsortedData[i],list.requestedSecuritiesById):unsortedData[i].identifier;securitiesData[identifier]=unsortedData[i];}
svInitValueResponseReceived=true;resortList();}
function onDataUpdated(data,oldData){if(!listContentReady()||deinitialized){return;}
if(!angular.isDefined(resortListPromise)){resortListPromise=$timeout(resortList,ModelRealtimeMoversCnstns.RESORT_LIST_MS);}
var isItemVisible=data.rowId!==-1;if(isItemVisible){notifier.publish('update',data,oldData);}}
function setOptions(newOptions){options=newOptions;if(getAdditionalInfoAjaxRequest){getAdditionalInfoAjaxRequest.cancel();}
var requestIsNotRequired=requestListByCriteria();if(requestIsNotRequired){notifier.publish('create',topMoversGridData());}else{realTimeProvider.setSecurities([]);notifier.publish('clear');forceCreateEvent=true;prevTopGainers=null;prevTopLosers=null;}}
function topMoversGridData(){return gridData;}
initialize();return{topMoversGridData:topMoversGridData,deinitialize:deinitialize,setOptions:setOptions,setSortOptions:setSortOptions,subscribe:notifier.subscribe,unsubscribe:notifier.unsubscribe};}
function portfolioListResolver(listId){return{serviceUrl:function(){return'/movers/portfolio/'+listId;},isValidResponse:function(response){return response&&angular.isArray(response);},getListFromResponse:function(response){var securities=[];angular.forEach(response,function(item){securities.push(item.preferred_id);});return{id:listId,securities:securities};},getAdditionalInfo:function(){return null;},getAvailableCurrencies:function(response){var currencies=[];var currenciesMap={};angular.forEach(response,function(item){var currency=item.primary_currency_code;if(currency&&!currenciesMap[currency]){currenciesMap[currency]=true;currencies.push(currency);}});return currencies;}};}
function watchListResolver(listId){var symbolInfoResponse;return{serviceUrl:function(){return'/movers/watchlist/'+listId;},isValidResponse:function(response){symbolInfoResponse=angular.copy(response);return response&&angular.isArray(response.securities);},getListFromResponse:function(response){var securities=[];angular.forEach(response.securities,function(security){securities.push(security.id);});return{id:listId,securities:securities};},getAdditionalInfo:function(){return angular.copy(symbolInfoResponse);},getAvailableCurrencies:function(response){return response&&response.availableCurrencies||[];}};}
function createListProvider(options,sortingOptions){sortingOptions=sortingOptions||{};if(options.watchListId!==undefined){options.listId=options.watchListId;return createGlobalListProvider(options,sortingOptions,watchListResolver(options.watchListId));}
else if(options.portfolioId!==undefined){options.listId=options.portfolioId;return createGlobalListProvider(options,sortingOptions,portfolioListResolver(options.portfolioId));}
else{return createGlobalListProvider(options,sortingOptions);}}
return{createListProvider:createListProvider};}
angular.module('ModuleRealtime').service('MoversListFactory',MoversListFactory);;"use strict";function ModelRealtimeMovers($log,ModelNotifier,MoversListFactory){var params={};var sortParams={};var listProvider=null;var notifier=ModelNotifier.createNotifier();function setParams(newParams){var options={moversType:newParams.moversType,assetType:newParams.assetType,maturity:newParams.maturity,sector:newParams.sector,spRating:newParams.spRating,currencies:newParams.currencies,};var listIdWasChanged=false;if(newParams&&newParams.watchListId!==undefined){listIdWasChanged=newParams.watchListId!==params.watchListId;options.watchListId=newParams.watchListId;}
else if(newParams&&newParams.portfolioId!==undefined){listIdWasChanged=newParams.portfolioId!==params.portfolioId;options.portfolioId=newParams.portfolioId;}
else if((listProvider===null)||(newParams&&(params.portfolioId||params.watchListId))){listIdWasChanged=true;}
params=newParams;notifier.publish('clear');if(listIdWasChanged){if(listProvider){unsubscribeFromListProvider();listProvider.deinitialize();}
listProvider=MoversListFactory.createListProvider(options,sortParams);subscribeToListProvider();}
else{listProvider.setOptions(options);}}
function setSortParams(params){sortParams=params;if(listProvider){listProvider.setSortOptions(sortParams);}}
function subscribeToListProvider(){listProvider.subscribe('create',function(data){notifier.publish('create',data);});listProvider.subscribe('update',function(data,oldData){notifier.publish('update',data,oldData);});listProvider.subscribe('change',function(data){notifier.publish('change',data);});listProvider.subscribe('clear',function(){notifier.publish('clear');});}
function unsubscribeFromListProvider(){listProvider.unsubscribe('create');listProvider.unsubscribe('update');listProvider.unsubscribe('change');listProvider.unsubscribe('clear');}
function gridData(){var result=listProvider&&listProvider.topMoversGridData();return result||[];}
return{gridData:gridData,setParams:setParams,setSortParams:setSortParams,subscribe:notifier.subscribe,unsubscribe:notifier.unsubscribe};}
angular.module('ModuleRealtime').service('ModelRealtimeMovers',ModelRealtimeMovers);;"use strict";function RealtimeCtrlMovers($scope,$cookieStore,$cookies,ModelWebSocket,MoversControlsSource,ModelRealtimeMovers,ModelRealtimeMoversCnstns,ModelRealtimeObserver,VtgProcessingComponents){$scope.ws=ModelWebSocket;$scope.pc=VtgProcessingComponents;$scope.wsClosedAt=null;$scope.socketReady=false;$scope.source=MoversControlsSource;$scope.sortOptions={};$scope.socketError=false;$scope.loading=true;$scope.noSecurities=false;$scope.noSecuritiesMsg="";$scope.securitiesReady=false;var authTime=$cookies.VANTAGE_AUTH_TIME;var sortOptionsDefaults={};sortOptionsDefaults[ModelRealtimeMoversCnstns.sortTypes.TOP_PRICE_CHANGE]={column:'px_chg',desc:true};sortOptionsDefaults[ModelRealtimeMoversCnstns.sortTypes.TOP_TRADES]={column:'count',desc:true};sortOptionsDefaults[ModelRealtimeMoversCnstns.sortTypes.TOP_VOLUME]={column:'volume',desc:true};function socketError(){if($scope.ws.error||($scope.socketReady&&($scope.ws.booted||$scope.ws.closed))){$scope.socketError=true;$scope.loading=false;$scope.noSecurities=false;$scope.securitiesReady=false;}}
function loading(){$scope.socketError=false;$scope.loading=true;$scope.noSecurities=false;$scope.securitiesReady=false;}
function notAvailableMsg(){var assetType=$scope.controlsValue.assetType;var isCrossBorder=['EMEACorpSov','EMEAMM','MBS'].indexOf(assetType)<0;var moversTypeMap={'TOP_TRADES':"Trades",'TOP_VOLUME':"Volume"};var criteria=moversTypeMap[$scope.controlsValue.moversType];if(isCrossBorder||!criteria){return"No securities match the criteria selected. Please change the criteria selected.";}
return["Top Securities by",criteria,"is not available for the Asset Type selected.","Please change the criteria selected."].join(' ');}
function noSecurities(){$scope.socketError=false;$scope.loading=false;$scope.noSecurities=true;$scope.securitiesReady=false;$scope.noSecuritiesMsg=notAvailableMsg();}
function securitiesReady(){$scope.socketError=false;$scope.loading=false;$scope.noSecurities=false;$scope.securitiesReady=true;}
function socketClosed(value,oldValue){if(value===true&&oldValue===false){$scope.wsClosedAt=new Date().getTime();}else{$scope.wsClosedAt=null;}
socketError();}
$scope.$watch('ws.closed',socketClosed);function socketBooted(value){if(value===true){$scope.wsClosedAt=new Date().getTime();}else{$scope.wsClosedAt=null;}
socketError();}
$scope.$watch('ws.booted',socketBooted);$scope.$watch('ws.error',socketError);function selectedWatchListId(listValue){var length=ModelRealtimeMoversCnstns.listPrefixes.WATCH_LIST_PREFIX.length;return(listValue.substring(0,length)===ModelRealtimeMoversCnstns.listPrefixes.WATCH_LIST_PREFIX)?listValue.substring(length):undefined;}
function selectedPortfolioId(listValue){var length=ModelRealtimeMoversCnstns.listPrefixes.PORTFOLIO_PREFIX.length;return(listValue.substring(0,length)===ModelRealtimeMoversCnstns.listPrefixes.PORTFOLIO_PREFIX)?listValue.substring(length):undefined;}
function saveObjectToCookies(key,object){$cookieStore.put(key,object);}
function restoreObjectFromCookies(key){return $cookieStore.get(key)||{};}
function validateMoversControlsValue(controlsValue){function findIndexById(array,id){for(var i=array.length-1;i>=0;--i){if(array[i].id===id){return i;}}
return-1;}
function defaultGetValidValueById(array,storedValue){if(findIndexById(array,storedValue)===-1){return null;}
return storedValue;}
function getValidValueById(array,storedValue,defaultValueId,getValidValueById){defaultValueId=findIndexById(array,defaultValueId)!==-1?defaultValueId:array[0].id;return getValidValueById(array,storedValue)||defaultValueId;}
function getValidMaturityValueById(array,storedValue){if(!storedValue){return null;}
var result=[];angular.forEach(storedValue.split('|'),function(item){if(findIndexById(array,item)!==-1){result.push(item);}});if(result.length===0){return null;}
return result.join('|');}
return{list:getValidValueById(MoversControlsSource.lists,controlsValue.list,null,defaultGetValidValueById),assetType:getValidValueById(MoversControlsSource.assetTypes,controlsValue.assetType,'USIG',defaultGetValidValueById),maturity:getValidMaturityValueById(MoversControlsSource.maturityTypes,controlsValue.maturity,null,getValidMaturityValueById),spRating:getValidValueById(MoversControlsSource.spRatings,controlsValue.spRating,null,defaultGetValidValueById),sector:getValidValueById(MoversControlsSource.sectors,controlsValue.sector,null,defaultGetValidValueById),moversType:getValidValueById(MoversControlsSource.moversTypes,controlsValue.moversType,null,defaultGetValidValueById),currencies:controlsValue.currencies};}
function saveSortOptionsToCookies(){var sortOptions=angular.copy($scope.sortOptions);sortOptions.authTime=authTime;saveObjectToCookies('moversGridSortOptions_'+params.moversType,sortOptions);}
function restoreSortOptionsFromCookies(){var moversType=(params&&params.moversType)||$scope.controlsValue.moversType;var sortOptions=restoreObjectFromCookies('moversGridSortOptions_'+moversType);if(sortOptions&&sortOptions.authTime===authTime){delete sortOptions.authTime;$scope.sortOptions=sortOptions;}else{$scope.sortOptions=angular.copy(sortOptionsDefaults[moversType]);}}
function saveControlsValueToCookies(criteria){saveObjectToCookies('moversControlValues',criteria);}
function restoreControlsValueFromCookies(){$scope.controlsValue=validateMoversControlsValue(restoreObjectFromCookies('moversControlValues'));}
var optionsRestoredFromCookies=false;function onControlsSourceReady(){restoreControlsValueFromCookies();restoreSortOptionsFromCookies();optionsRestoredFromCookies=true;}
$scope.$watch('source.ready',function(ready){if(!ready){return;}
onControlsSourceReady();});if($scope.source.ready){onControlsSourceReady();}
$scope.controlsValue={};var params;$scope.applyCriteria=function(criteria){if(!optionsRestoredFromCookies){return;}
params={moversType:criteria.moversType,assetType:criteria.assetType,maturity:criteria.maturity,sector:criteria.sector,spRating:criteria.spRating,currencies:criteria.currencies};if(!MoversControlsSource.ready){return;}
var portfolioId=selectedPortfolioId(criteria.list);var watchListId=selectedWatchListId(criteria.list);if(portfolioId!==undefined){params.portfolioId=portfolioId;}
if(watchListId!==undefined){params.watchListId=watchListId;}
ModelRealtimeMovers.setParams(params);saveControlsValueToCookies(criteria);restoreSortOptionsFromCookies();ModelRealtimeMovers.setSortParams($scope.sortOptions);};function sortOptionChanged(value,prevValue){if(!optionsRestoredFromCookies||!params){return;}
ModelRealtimeMovers.setSortParams($scope.sortOptions);saveSortOptionsToCookies();}
$scope.$watch('sortOptions.desc',sortOptionChanged);$scope.$watch('sortOptions.column',sortOptionChanged);ModelRealtimeObserver.subscribe(["sv.get.watch"],function(){$scope.socketReady=true;});ModelRealtimeMovers.subscribe('create',function(){var gridData=ModelRealtimeMovers.gridData();if(gridData.length>0){securitiesReady();}else{noSecurities();}});ModelRealtimeMovers.subscribe('clear',function(){if($scope.socketReady){loading();}});}
angular.module('ModuleRealtime').controller('CtrlMovers',RealtimeCtrlMovers);;function DirectiveRealtimeMoversGrid($filter,ModelRealtimeMovers,MoversControlsSource,ModelRealtimeMoversCnstns,Auth,PriceFormattingService){var addCusipChecksum=$filter('FilterAddCusipChecksumDigit');return{scope:{sortOptions:'='},restrict:'C',template:'<div ng-show="notEmptyGrid && auth.canViewNoTrace()" id="delayed-indicator" style="height: 5px">'+'<button class="btn btn-default btn-xs" style="background-color: #2a9fd6; float: right">'+'<i class="fa fa-exclamation-triangle"></i> <span>Trade Data is Delayed</span>'+'</button>'+'</div>'+'<div class="table table-styled table-intraday table-cep" id="movers-grid-container"></div>',link:function(scope,elem){scope.auth=Auth;scope.notEmptyGrid=false;function updatePriceCells(){$(elem).find('[name=gridPriceCell]').each(function(index,element){var item=$(element);var priceValue=item.attr('price-value');var assetClass=item.attr('asset-class');var formatter=PriceFormattingService.getFormatterExt({assetTypeOrClass:assetClass||null});item.text(formatter(priceValue,{defaultValue:'--'}));});}
scope.formattingService=PriceFormattingService;PriceFormattingService.subscribeOnTreasuryTBAPriceFormatterChanged(window,scope,'formattingService',updatePriceCells);var columnMinWidths=[0,40,175,160,100,60,60,68,70,72,45,68,64,90,60,260];var sortingInitialized=false;var highlightedItems=[];if(!scope.sortOptions){scope.sortOptions={desc:false};}
function resizeJQGrid(){resizeThisGrid("realtime-grid",columnMinWidths);if($(".ui-jqgrid-htable tr").length>2){var groupedHeaderHeight=$(".jqg-first-row-header").height()+
$(".jqg-second-row-header").height()+1;var normalHeaderHeight=$(".jqg-third-row-header").height();$(".frozen-div.ui-state-default.ui-jqgrid-hdiv .jqg-second-row-header").remove();$(".frozen-div.ui-state-default.ui-jqgrid-hdiv").css("top",normalHeaderHeight+"px");$(".frozen-bdiv.ui-jqgrid-bdiv").css("top",normalHeaderHeight+groupedHeaderHeight+"px");}
$(".frozen-bdiv.ui-jqgrid-bdiv").css("overflow-y","hidden").css("overflow-x","hidden");}
function setupRowHovers(){$('.DirectiveRealtimeMoversGrid tr[id]').hover(function(){var i=$(this).index()+1;$('.DirectiveRealtimeMoversGrid tr').filter(':nth-child('+i+')').addClass('row_highlighted');},function(){var i=$(this).index()+1;$('.DirectiveRealtimeMoversGrid tr').filter(':nth-child('+i+')').removeClass('row_highlighted');});}
function formatterString(cellvalue){return(cellvalue!==null)?cellvalue:'-';}
function formatterDate(cellvalue){return(cellvalue!==null)?$filter('VtgFormatDate')(cellvalue):'-';}
function formatterFloat(cellvalue){return(cellvalue!==null)?$filter('VtgFormatFloat')(cellvalue):'-';}
function formatterVolume(cellvalue){return(cellvalue!==null)?$filter('VtgFormatNumber')(cellvalue):'-';}
function formatterUpTime(cellvalue,options,rowObject){return(cellvalue!=null)?$filter('VtgFormatUnixTimestampToTime')(cellvalue):'-';}
function delayedTradeFormatter(formatterFn,showCircle){return function(cellvalue,options,rowObject){var result=formatterFn(cellvalue,options,rowObject);if(!rowObject.ltDelay||result==='-'||Auth.canViewNoTrace()){return result;}
return['<span class="delayed-data" title="Delayed by ',rowObject.ltDelay,' hours">',(showCircle?'&#9899 ':''),result,'</span>'].join('');};}
function formatterPrice(cellValue,options,rowObject){var item=$('<span>');item.attr('name','gridPriceCell');item.attr('price-value',cellValue);var assetClass=rowObject.assetType||rowObject.asset_class;item.attr('asset-class',assetClass);var formatter=scope.formattingService.getFormatterExt({assetTypeOrClass:assetClass||null});var formattedValue=formatter(cellValue,{defaultValue:'-'});item.text(formattedValue);return item[0].outerHTML;}
function formatterMaturity(cellValue){if(angular.isString(cellValue)){var result=MoversControlsSource.getMaturityName(cellValue);if(!result){return cellValue;}
if(result==='Perpetual'){return'P';}else if(result==='Short'){return'Sh';}else if(angular.isString(result)){return result;}}
return'n/a';}
function formatterSector(cellValue){var result=MoversControlsSource.getSectorName(cellValue);if(result){return"<span title='"+result+"'>"+result+"</span>";}else if(cellValue){return"<span title='"+cellValue+"'>"+cellValue+"</span>";}else{return'-';}}
function formatterIssuer(cellValue){if(cellValue){return"<span title='"+cellValue+"'>"+cellValue+"</span>";}else{return'-';}}
function formatterTradeType(cellValue){if(!cellValue){return'-';}
switch(cellValue){case'B':return'Buy';case'S':return'Sell';case'D':return'Dlr';}
return cellValue;}
function formatterRating(cellValue){var result=MoversControlsSource.getSpRatingName(cellValue);return result||cellValue||'';}
function formatterDesc(cellvalue,options,rowObject){return $filter('VtgFormatIssue')(rowObject);}
function formatterIdentifier(cellvalue,options,rowObject){return['<a href="/transparency?secid=',rowObject.identifier,'&source=cep&prefId=',rowObject.identifier,'" target="_blank" title="',(!Auth.isLoggedIn()?ModelRealtimeMoversCnstns.CONTACTS_MESSAGE:''),'">',addCusipChecksum(rowObject.identifier),'</a>'].join('');}
function getColumns(){var columnList=[{name:"rowId",label:"Id",hidden:true,key:true,width:columnMinWidths[0],frozen:true},{label:"Mat",width:columnMinWidths[1],align:'left',name:"maturity",formatter:formatterMaturity,sortable:false,frozen:true},{label:"Issuer",width:columnMinWidths[2],align:'left',name:"issuer",formatter:formatterIssuer,sortable:false,frozen:true},{label:"Issue",width:columnMinWidths[3],align:'left',name:"coupon",formatter:formatterDesc,sortable:false,frozen:true},{label:"Identifier",width:columnMinWidths[4],frozen:true,name:"identifier",formatter:formatterIdentifier,sortable:false},{label:"Current",width:columnMinWidths[5],align:'right',name:"bid_price",formatter:formatterPrice,sortable:false},{label:"Px Chg",width:columnMinWidths[6],align:'right',name:"px_chg",formatter:formatterPrice,sortable:false},{label:"Time",width:columnMinWidths[7],align:'center',name:"t",formatter:formatterUpTime,sortable:false},{label:"Price",width:columnMinWidths[8],align:'right',name:"ltPrice",formatter:delayedTradeFormatter(formatterPrice,true),sortable:false},{label:"Size",width:columnMinWidths[9],align:'right',name:"ltSize",formatter:delayedTradeFormatter(formatterVolume),sortable:false},{label:"Type",width:columnMinWidths[10],align:'left',name:"ltSide",formatter:delayedTradeFormatter(formatterTradeType),sortable:false},{label:"Time",width:columnMinWidths[11],align:'left',name:"ltTime",formatter:delayedTradeFormatter(formatterUpTime),sortable:false},{label:"#Trades",width:columnMinWidths[12],align:'right',name:"count",sortable:false,formatter:formatterVolume},{label:"Volume",width:columnMinWidths[13],align:'right',name:"volume",sortable:false,formatter:formatterVolume},{label:"Ratings",width:columnMinWidths[14],align:'center',name:"spRating",formatter:formatterRating,sortable:false},{label:"Sector",width:columnMinWidths[15],align:'left',name:"sectorId",formatter:formatterSector,sortable:false}];return columnList;}
function getGridConfig(){var data=ModelRealtimeMovers.gridData();var rowIdsString='';angular.forEach(data,function(currentItem){rowIdsString+=currentItem.rowId+' ';});var columnList=getColumns();return{source:'local',alt:true,rows:data.length,column:columnList,data:data,groupHeader:{groupHeaders:[{startColumnName:'ltPrice',numberOfColumns:4,titleText:'Last Trade'}]},postLoad:gridPostLoad};}
function cellHighlight(highlight,position,column){var identifierColumn=jQuery("#realtime-grid"+"_identifier").index()+1;var tid="#realtime-grid";var element=jQuery(tid+" tbody tr#"+position+" td:nth-child("+column+")");var identifierText=jQuery(tid+" tbody tr#"+position+" td:nth-child("+identifierColumn+")").text();var color="#ffff99";if(highlight<0){color="#cc3333";}else if(highlight>0){color="#00cc66";}
var duration=5000;addHighlighInfo(element,identifierText,position,column,duration);startHighlightAnimation(element,identifierText,column,color,duration)}
function startHighlightAnimation(element,identifier,column,color,duration){var origColor=element.parents("tr").find("td:first-child").css("background-color");element.css({"background-color":color}).stop().animate({"background-color":origColor},duration,function(){element.css({"background-color":""});removeHighlightInfo(identifier,column);});}
function addHighlighInfo(element,identifier,row,column,duration){highlightedItems.push({endTime:(new Date()).getTime()+duration,identifier:identifier,column:column,row:row,element:element});}
function removeHighlightInfo(identifier,column){var item;for(var i=0;i<highlightedItems.length;){item=highlightedItems[i];if(item.identifier===identifier&&item.column===column){highlightedItems.splice(i,1);}else{i++;}}}
function fixCellsHighlighting(){var prevHihglightedItems=highlightedItems.slice(0,highlightedItems.length);var item;for(var i=0;i<prevHihglightedItems.length;i++){item=prevHihglightedItems[i];var identifierCell=jQuery('#realtime-grid td[aria-describedby="realtime-grid_identifier"]:contains("'+item.identifier+'")');if(identifierCell.length===1){var row=identifierCell.parent().attr('id');if(item.row!=row){var color=item.element.css('background-color');var duration=item.endTime-(new Date()).getTime();item.element.stop(false,true);var newCell=identifierCell.parent().find("td:nth-child("+item.column+")");addHighlighInfo(newCell,item.identifier,row,item.column,duration);startHighlightAnimation(newCell,item.identifier,item.column,color,duration);}}}}
function gridPostLoad(){var grid=jQuery("#realtime-grid");grid.jqGrid('setLabel','bid_price','','rt');grid.jqGrid('setLabel','t','','ctr');grid.jqGrid('setLabel','px_chg','','rt');grid.jqGrid('setLabel','ltPrice','','rt');grid.jqGrid('setLabel','ltSize','','rt');grid.jqGrid('setLabel','count','','rt');grid.jqGrid('setLabel','volume','','rt');setIE8Stripes("#gview_realtime-grid");setIE8Stripes(".frozen-bdiv");setupRowHovers();$("#realtime-grid"+"_market_id").removeClass("rt");$("#realtime-grid"+"_base_index").removeClass("ctr");function updateSortingColumn(oldColumn){if(!scope.sortOptions.column){return;}
if(oldColumn&&scope.sortOptions.column!==oldColumn){$('#jqgh_realtime-grid_'+oldColumn+'>span').css('display','none');$('#jqgh_realtime-grid_'+oldColumn).css('margin-right','');}
var headerElement=$('#jqgh_realtime-grid_'+scope.sortOptions.column);var sortSpan=$('#jqgh_realtime-grid_'+scope.sortOptions.column+'>span');sortSpan.css('display','inline');sortSpan.parents('th[align="right"].ui-jqgrid-sortable>div').css('margin-right','0.3em');if(scope.sortOptions.desc){sortSpan.find('span[sort="asc"]').addClass('ui-state-disabled');sortSpan.find('span[sort="desc"]').removeClass('ui-state-disabled');}else{sortSpan.find('span[sort="desc"]').addClass('ui-state-disabled');sortSpan.find('span[sort="asc"]').removeClass('ui-state-disabled');}}
if(!sortingInitialized){updateSortingColumn();scope.$watch('sortOptions',function(newValue,oldValue){updateSortingColumn(oldValue.column);});sortingInitialized=true;var columnList=getColumns();angular.forEach(columnList,function(column){if(column.hidden){return;}
$('th#realtime-grid_'+column.name).addClass('ui-jqgrid-sortable').click(function(){scope.$apply(function(){if(scope.sortOptions.column!==column.name){var oldColumn=scope.sortOptions.column;scope.sortOptions.column=column.name;scope.sortOptions.desc=false;}else{scope.sortOptions.desc=!scope.sortOptions.desc;}
updateSortingColumn(oldColumn);});});});}}
function columnIndex(column){return $('#realtime-grid_'+column).index()+1;}
function updateIntradayGridRow(data,oldData){if(!data||!oldData){return;}
var position=data['rowId'];jQuery("#realtime-grid").setRowData(position,data,'');var highlightPrice=0;var highlightTrade=0;var highlightPxChg=0;if(angular.isNumber(data.bid_price)&&angular.isNumber(oldData.bid_price)){highlightPrice=data.bid_price-oldData.bid_price;}
if(angular.isNumber(data.px_chg)&&angular.isNumber(oldData.px_chg)){highlightPxChg=data.px_chg-oldData.px_chg;}
if(angular.isNumber(data.volume)&&angular.isNumber(oldData.volume)){highlightTrade=data.volume-oldData.volume;}
var highlightPriceAndPxChg=highlightPrice||highlightPxChg;if(highlightPriceAndPxChg){cellHighlight(highlightPriceAndPxChg,position,columnIndex('bid_price'));cellHighlight(highlightPriceAndPxChg,position,columnIndex('px_chg'));}
if(highlightTrade>0){cellHighlight(highlightTrade,position,columnIndex('count'));cellHighlight(highlightTrade,position,columnIndex('volume'));}}
function changeIntradayGrid(){var data=ModelRealtimeMovers.gridData();var grid=jQuery("#realtime-grid");var position,cssClass;angular.forEach(data,function(currentItem){position=currentItem.rowId;cssClass='';if(currentItem.gainersHeader===true){return;}
else if(currentItem.losersHeader===true){return;}
grid.setRowData(position,currentItem,cssClass);});fixCellsHighlighting();}
function clearIntradayGrid(){scope.notEmptyGrid=false;$(elem).find('.ui-jqgrid').remove();$('#realtime-grid').remove();$(elem).append("<table id='realtime-grid"+"' class='table table-styled table-intraday'></table>");}
function createGrid(){clearIntradayGrid();var config=getGridConfig();if(config.data.length!==0){scope.notEmptyGrid=true;sortingInitialized=false;var Obj_Workflow_Grid=new Class_VTG_JQ_GRID_Wrapper();Obj_Workflow_Grid.create("realtime-grid",null,config);jQuery("#realtime-grid").jqGrid('setFrozenColumns').trigger('reloadGrid',[{current:true}]);var newFixedTableHeight=$(".frozen-bdiv.ui-jqgrid-bdiv").height()+17;$(".frozen-bdiv.ui-jqgrid-bdiv").css("height",newFixedTableHeight);setColumnSortIcons();setAlignGroupedHeaders();resizeJQGrid();var frozenHeadersFixed=false;$("#realtime-grid").bind('jqGridAfterGridComplete.setFrozenColumns',debouncer(function(e){if(!frozenHeadersFixed){frozenHeadersFixed=true;syncFrozenHeaders('realtime-grid');}}));var data=ModelRealtimeMovers.gridData();var position,cssClass;var grid=jQuery("#realtime-grid");angular.forEach(data,function(currentItem){position=currentItem['rowId'];cssClass='';if(currentItem.gainersHeader===true){cssClass='gainers-header';}
else if(currentItem.losersHeader===true){cssClass='losers-header';}
if(cssClass.length>0){var element=jQuery("#realtime-grid tbody tr#"+position+" td:nth-child(3)");element.attr('colspan',15);jQuery("#realtime-grid tbody tr#"+position+" td:not(:nth-child(3))").remove();}
grid.setRowData(position,{},cssClass);});syncFrozenRows('realtime-grid');jQuery(window).resize(debouncer(function(e){resizeJQGrid();}));}}
ModelRealtimeMovers.subscribe(["clear"],function(){clearIntradayGrid();});ModelRealtimeMovers.subscribe(["create"],function(){createGrid();});ModelRealtimeMovers.subscribe(["change"],changeIntradayGrid);ModelRealtimeMovers.subscribe(["update"],updateIntradayGridRow);}};}
angular.module('ModuleRealtime').directive('DirectiveRealtimeMoversGrid',DirectiveRealtimeMoversGrid);;var moverscontrolsTemplateHtml='<div class="btn-group" id="movers-mode-buttons">'+'<button type="button" id="movers-mode" class="btn btn-default dropdown-toggle btn-xs" ng-disabled="!source.ready"'+'data-toggle="dropdown" aria-expanded="false">'+'<span class="currentView">{{ moversType.name }}</span> <span class="caret"></span>'+'</button>'+'<ul class="dropdown-menu currentViewSelector" role="menu">'+'<li ng-repeat="item in source.moversTypes">'+'<a href ng-click="setCurrentMoversType(item)">{{ item.name }}</a>'+'</li>'+'</ul>'+'</div>'+'<div class="row">'+'<div class="col-md-2">'+'<span class="sectionHeader">Asset Type</span>'+'<select name="" id="movers-asset-type" class="form-control input-sm" ng-model="innerValue.assetType" ng-disabled="!source.ready"'+'ng-options="item.id as item.name for item in source.assetTypes" >'+'</select>'+'</div>'+'<div class="col-md-3">'+'<span class="sectionHeader">Universe</span>'+'<select name="" id="movers-list" class="form-control input-sm" ng-model="innerValue.list" '+'ng-disabled="!isLoggedIn || !source.ready" title="{{ contactsMsg }}" '+'ng-options="item.id as item.name group by item.group for item in source.lists" >'+'</select>'+'</div>'+'<div class="col-md-1">'+'<span class="sectionHeader">Ccy</span>'+'<p class="text-center buffer_top" title="{{ contactsMsg }}">'+'{{ selectedCurrencies }} <span ng-show="isLoggedIn">(<a data-toggle="modal" href="#gdCurrencies" >edit</a>)</span>'+'</p>'+'</div>'+'<div class="col-md-2">'+'<span class="sectionHeader">Maturity</span>'+'<select id="movers-maturity" class="bootstrap-multiselect form-control input-sm" multiple="multiple"></select>'+'</div>'+'<div class="col-md-2">'+'<span class="sectionHeader">Sector</span>'+'<select name="" id="movers-sector" class="form-control input-sm" ng-model="innerValue.sector" '+'ng-disabled="!isLoggedIn || !source.ready" title="{{ contactsMsg }}" '+'ng-options="item.id as item.name for item in source.sectors">'+'</select>'+'</div>'+'<div class="col-md-2">'+'<span class="sectionHeader">S&amp;P Rating</span>'+'<select name="sp_min" id="movers-rating" class="form-control input-sm" ng-model="innerValue.spRating" '+'ng-disabled="!isLoggedIn || !source.ready" title="{{ contactsMsg }}" '+'ng-options="item.id as item.name for item in source.spRatings">'+'</select>'+'</div>'+'</div>'+'<div class="row" id="movers-apply-row" style="margin-top: 5px" ng-show="source.ready && useApply && dirty">'+'<div class="col-md-1 col-md-offset-11">'+'<button id="movers-apply" type="button" style="width: 100%" ng-show="useApply" ng-click="apply()">Apply</button>'+'</div>'+'</div>'+'<!-- gdCurrencies modal window -->'+'<div class="modal fade" id="gdCurrencies" tabindex="-1" role="dialog" aria-labelledby="gdCurrencies" aria-hidden="true">'+'<div class="modal-dialog" style="width:700px">'+'<div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+'<h4 class="modal-title">Currency Filters</h4>'+'</div>'+'<div class="modal-body">'+'<div class="row">'+'<div class="col-md-12">'+'<a href="javascript:void(0)" ng-click="selectAllCurrencies()">select all</a> / <a href="javascript:void(0)" ng-click="deselectAllCurrencies()">de-select all</a>'+'</div>'+'</div>'+'<div class="row">'+'<div class="col-md-4 currencies-row-1">'+'</div>'+'<div class="col-md-4 currencies-row-2">'+'</div>'+'<div class="col-md-4 currencies-row-3">'+'</div>'+'</div>'+'</div>'+'<div class="modal-footer">'+'<button type="button" class="btn btn-default btn-sm" data-dismiss="modal" ng-click="applyCurrencies()">Done</button>'+'</div>'+'</div><!-- /.modal-content -->'+'</div><!-- /.modal-dialog -->'+'</div><!-- /.modal -->'+'<!-- end gdCurrencies -->';function DirectiveRealtimeMoversControls(MoversControlsSource,ModelRealtimeMoversCnstns,Auth,$timeout,$compile,$filter){return{scope:{applyCriteria:'=',controlsValue:'='},restrict:'C',template:moverscontrolsTemplateHtml,link:function(scope,element,attrs){scope.source=MoversControlsSource;function saveSelectedMaturitiesForDownloadButton(){element.find('#movers-maturity').attr('selected-options',MoversControlsSource.getMaturityName(scope.innerValue.maturity));}
function getMaturityButtonText(selectedOptions){if((selectedOptions.length==MoversControlsSource.maturityTypes.length-1)){return MoversControlsSource.maturityTypes[0].name;}else if(selectedOptions.length===0){return'- All -';}else if(selectedOptions.length>3){return selectedOptions.length+' selected';}else{var labels=[];selectedOptions.each(function(){labels.push($(this).text());});return labels.join(', ');}}
function onSelectChange(){var selectedOptions=element.find('#movers-maturity').find('option:selected');var oldValue=scope.innerValue.maturity;if((selectedOptions.length===0)||(selectedOptions.length===MoversControlsSource.maturityTypes.length-1)){scope.innerValue.maturity=ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL;}else{var result=[];selectedOptions.each(function(){var option=$(this);result.push(option.attr('value'));});scope.innerValue.maturity=result.join('|');}
if(oldValue===scope.innerValue.maturity){return;}
saveSelectedMaturitiesForDownloadButton();}
element.find('#movers-maturity').multiselect({buttonClass:'btn btn-sm input-auto',buttonWidth:'100%',includeSelectAllOption:true,selectAllText:MoversControlsSource.maturityTypes[0].name,selectAllValue:MoversControlsSource.maturityTypes[0].id,disableIfEmpty:true,onChange:function(){$timeout(onSelectChange);},onSelectAll:function(){$timeout(onSelectChange);},buttonText:getMaturityButtonText});function updateMaturityControl(){var selectControl=element.find('#movers-maturity');var selectButtonContainer=selectControl.next();if(scope.isLoggedIn&&MoversControlsSource.ready){selectControl.multiselect('enable');if(scope.innerValue.maturity===ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL){selectControl.multiselect('selectAll',false);}else{selectControl.multiselect('deselectAll',false);if(scope.innerValue.maturity){selectControl.multiselect('select',scope.innerValue.maturity.split('|'));}}}else{selectControl.multiselect('selectAll',false);selectControl.multiselect('disable');selectButtonContainer.find('.multiselect').css('color','black');}
selectButtonContainer.css('cursor',scope.isLoggedIn?'':'not-allowed');selectButtonContainer.attr('title',scope.contactsMsg);selectButtonContainer.find('.multiselect').css('color','black');selectControl.multiselect('updateButtonText');}
scope.$watch('source.maturityTypes',function(){var selectControl=element.find('#movers-maturity');selectControl.empty();angular.forEach(MoversControlsSource.maturityTypes,function(typeObj){if(typeObj.id===ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL){return;}
var option=$('<option value="'+typeObj.id+'">'+typeObj.name+'</option>');option.appendTo(selectControl);});selectControl.multiselect('rebuild');updateMaturityControl();},true);scope.$watch(function(){return Auth.isLoggedIn();},function(){scope.isLoggedIn=Auth.isLoggedIn();scope.contactsMsg=!Auth.isLoggedIn()?ModelRealtimeMoversCnstns.CONTACTS_MESSAGE:'';updateMaturityControl();});scope.dirty=true;scope.useApply='useApply'in attrs;scope.innerValue={list:MoversControlsSource.lists[0].id,assetType:MoversControlsSource.assetTypes[0].id,maturity:MoversControlsSource.maturityTypes[0].id,spRating:MoversControlsSource.spRatings[0].id,sector:MoversControlsSource.sectors[0].id,moversType:MoversControlsSource.moversTypes[0].id,currencies:[],currenciesInternal:[]};scope.moversType=MoversControlsSource.moversTypes[0];scope.setCurrentMoversType=function(item){scope.innerValue.moversType=item.id;scope.moversType=item;};scope.selectedCurrencies='All';function updateSelectedSecuritiesCount(){if(!scope.innerValue.currencies||scope.innerValue.currencies.length===0){scope.selectedCurrencies='All';return;}
scope.selectedCurrencies=0;angular.forEach(scope.innerValue.currencies,function(currencyId){if(MoversControlsSource.isCurrencyAvailable(currencyId)){scope.selectedCurrencies++;}});if(scope.selectedCurrencies===MoversControlsSource.allCurrencies.length||scope.selectedCurrencies===0){scope.selectedCurrencies='All';}}
MoversControlsSource.subscribe('availableCurrenciesChanged',updateSelectedSecuritiesCount);MoversControlsSource.subscribe('allCurrenciesChanged',updateSelectedSecuritiesCount);var currenciesRow1=$(element).find('.currencies-row-1');var currenciesRow2=$(element).find('.currencies-row-2');var currenciesRow3=$(element).find('.currencies-row-3');scope.$watch('source.allCurrencies',function(){currenciesRow1.html('');currenciesRow2.html('');currenciesRow3.html('');var currenciesCount=scope.source.allCurrencies.length;var currencyIndex=0;var secondColumnFirstIndex=Math.floor(currenciesCount/3);var thirdColumnFirstIndex=secondColumnFirstIndex+Math.floor((currenciesCount-secondColumnFirstIndex)/2);var currentColumn=currenciesRow1;angular.forEach(scope.source.allCurrencies,function(currency){var elementScope=scope.$new();elementScope.currency=currency;elementScope.isSelected=$filter('VtgArrayIndexOf')(scope.innerValue.currenciesInternal,currency.id)!==-1;elementScope.$on('select-all',function(){if(scope.source.isCurrencyAvailable(currency.id)){elementScope.isSelected=true;}});elementScope.$on('de-select-all',function(){if(scope.source.isCurrencyAvailable(currency.id)){elementScope.isSelected=false;}});function updateSelection(){elementScope.isSelected=$filter('VtgArrayIndexOf')(scope.innerValue.currenciesInternal,currency.id)!==-1;}
scope.$watch('innerValue',updateSelection);scope.$watch('innerValue.currenciesInternal',updateSelection);function updateSelectedCurrencies(){if(!scope.source.isCurrencyAvailable(elementScope.currency.id)){return;}
var currencies=scope.innerValue.currenciesInternal;var index=$filter('VtgArrayIndexOf')(currencies,elementScope.currency.id);if(elementScope.isSelected&&index===-1){currencies.push(elementScope.currency.id);}else if(!elementScope.isSelected&&index!==-1){currencies.splice(index,1);}}
elementScope.$watch('isSelected',updateSelectedCurrencies);elementScope.$watch(function(){return scope.source.isCurrencyAvailable(currency.id);},function(){updateSelectedCurrencies();scope.applyCurrencies();});var currencyHtmlElement=$(''+'<div class="checkbox">'+'<label>'+'<input type="checkbox" ng-model="isSelected" ng-disabled="!source.ready || !source.isCurrencyAvailable(currency.id)">'+'{{ currency.id }} - {{ currency.name }}'+'</label> '+'</div>');currentColumn.append(currencyHtmlElement);$compile(currencyHtmlElement.contents())(elementScope);currencyIndex++;if(currencyIndex===secondColumnFirstIndex){currentColumn=currenciesRow2;}else if(currencyIndex===thirdColumnFirstIndex){currentColumn=currenciesRow3;}});});scope.selectAllCurrencies=function(){scope.innerValue.currenciesInternal=[];angular.forEach(MoversControlsSource.allCurrencies,function(currency){if(MoversControlsSource.isCurrencyAvailable(currency.id)){scope.innerValue.currenciesInternal.push(currency.id);}});scope.$broadcast('select-all');};scope.deselectAllCurrencies=function(){scope.innerValue.currenciesInternal=[];scope.$broadcast('de-select-all');};$(element).find('#gdCurrencies').on('hidden.bs.modal',function(){scope.$apply(function(){scope.clearCurrenciesChanges();});});scope.applyCurrencies=function(){scope.innerValue.currencies=angular.copy(scope.innerValue.currenciesInternal);};scope.clearCurrenciesChanges=function(){scope.innerValue.currenciesInternal=angular.copy(scope.innerValue.currencies);};if($('.realtimeSelector').length){var moversModeButtons=$('#movers-mode-buttons');moversModeButtons.remove();$('.realtimeSelector').append(moversModeButtons);}
function setupSectorControl(){if(typeof Awesomplete!=='function'){return;}
var defaultValue=MoversControlsSource.sectors[0].id;var defaultLabel=MoversControlsSource.sectors[0].name;var sectorControl=element.find('#movers-sector');var sectorControlParent=sectorControl.parent();sectorControl.css('display','none');var inputElement=$compile('<input class="myinput form-control input-sm inputSector" '+'ng-disabled="!isLoggedIn || !source.ready" title="{{ contactsMsg }}" '+'placeholder="'+defaultLabel+'" />')(scope);if(inputElement.placeholder){inputElement.placeholder(defaultLabel);}
sectorControlParent.append(inputElement);var list=[];angular.forEach(MoversControlsSource.sectors,function(sector){list.push(sector.name);});inputElement.on('awesomplete-selectcomplete',function(event){var sectorName=inputElement.val();var sectorId=MoversControlsSource.getSectorId(sectorName);scope.$apply(function(){scope.innerValue.sector=sectorId;});});var awesomplete=new Awesomplete(inputElement.get(0),{list:list});var searchClearElement=jQuery('<span class="searchclear fa fa-times" style="display: none;"></span>');sectorControlParent.append(searchClearElement);searchClearElement.click(function(){inputElement.val('').blur();scope.$apply(function(){scope.innerValue.sector=defaultValue;});$(this).fadeOut("fast");});inputElement.keyup(function(){if($(this).val()!=""){searchClearElement.fadeIn("fast");}else{searchClearElement.fadeOut("fast");}});inputElement.focusout(function(){if($(this).val()===""){searchClearElement.click();}});var currentValue=MoversControlsSource.getSectorName(scope.innerValue.sector);if(currentValue!==defaultLabel){inputElement.val(currentValue);if(currentValue!==""){searchClearElement.fadeIn("fast");}}}
function onSourceReady(ready){if(ready){$timeout(function(){setupSectorControl();controlsValueChanged();if(!scope.useApply){scope.apply();}});}}
scope.$watch('source.ready',onSourceReady);scope.apply=function(){scope.controlsValue=angular.copy(scope.innerValue);if(angular.isFunction(scope.applyCriteria)){scope.applyCriteria(scope.controlsValue);}
scope.dirty=false;};function paramsChanged(value,oldValue){if(value===oldValue){return;}
if(scope.useApply){scope.dirty=!angular.equals(scope.controlsValue,scope.innerValue);}else{if(!angular.equals(scope.controlsValue,scope.innerValue)){scope.apply();}}}
scope.$watch('innerValue.list',paramsChanged);scope.$watch('innerValue.maturity',paramsChanged);scope.$watch('innerValue.sector',paramsChanged);scope.$watch('innerValue.assetType',paramsChanged);scope.$watch('innerValue.spRating',paramsChanged);scope.$watch('innerValue.moversType',paramsChanged);scope.$watch('innerValue.currencies',function(value,oldValue){paramsChanged(value,oldValue);updateSelectedSecuritiesCount();},true);function controlsValueChanged(){if(scope.controlsValue===undefined||angular.equals(scope.controlsValue,scope.innerValue)||angular.equals(scope.controlsValue,{})){return;}
scope.innerValue=scope.controlsValue;if(!scope.innerValue.currencies){scope.innerValue.currencies=[];}
scope.innerValue.currenciesInternal=angular.copy(scope.innerValue.currencies);if(scope.controlsValue&&scope.controlsValue.moversType){for(var i=0;i<MoversControlsSource.moversTypes.length;++i){if(scope.controlsValue.moversType===MoversControlsSource.moversTypes[i].id){scope.moversType=MoversControlsSource.moversTypes[i];break;}}}
updateMaturityControl();saveSelectedMaturitiesForDownloadButton();}
saveSelectedMaturitiesForDownloadButton();scope.$watch('controlsValue',controlsValueChanged);}};}
angular.module('ModuleRealtime').directive('DirectiveRealtimeMoversControls',DirectiveRealtimeMoversControls);;function MoversControlsSource(ModelHttp,ServiceModal,ModelRealtimeMoversCnstns,ModelRealtimeCnstnt,$filter,ModelNotifier,$rootScope){var notifier=ModelNotifier.createNotifier();var result;var lists=[{id:ModelRealtimeMoversCnstns.listTypes.LIST_ALL,name:'All IDC Securities'}];var sectors=[{id:ModelRealtimeMoversCnstns.sectorTypes.SECTOR_ALL,name:'- All -'}];var assetTypes=[{id:ModelRealtimeMoversCnstns.assetTypes.ASSET_ALL,name:'- All -'}];var maturityTypes=[{id:ModelRealtimeMoversCnstns.maturityTypes.MAT_ALL,name:'- All -'}];var allCurrencies=[{"id":"AED","name":"Arab Emirate Dirham"},{"id":"ARS","name":"Argentinian Peso"},{"id":"AUD","name":"Australian Dollar"},{"id":"BHD","name":"Bahraini Dinars"},{"id":"GBP","name":"British Pound"},{"id":"BRL","name":"Brazilian Real"},{"id":"BGN","name":"Bulgarian Lev"},{"id":"CAD","name":"Canadian $"},{"id":"CLP","name":"Chiliean Peso"},{"id":"CNY","name":"Chinese Yuan"},{"id":"COP","name":"Colombian Peso"},{"id":"HRK","name":"Croatian Kuna"},{"id":"CZK","name":"Czech Koruna"},{"id":"DKK","name":"Danish Krone"},{"id":"EGP","name":"Egyptian £"},{"id":"EUR","name":"Euro"},{"id":"GHS","name":"Ghanian Cedi"},{"id":"HKD","name":"Hong Kong Dollar"},{"id":"PLN","name":"Polish Zloty"},{"id":"QAR","name":"Qatar Riyal"},{"id":"RON","name":"Romanian Leu"},{"id":"RUB","name":"Russian Ruble"},{"id":"RSD","name":"Serbian Dinar"},{"id":"SGD","name":"Singapore $"},{"id":"ZAR","name":"South African Rand"},{"id":"KRW","name":"South Korean Wan"},{"id":"LKR","name":"Sri Lanka"},{"id":"SEK","name":"Swedish Krona"},{"id":"CHF","name":"Swiss Franc"},{"id":"TWD","name":"Taiwan $"},{"id":"THB","name":"Thai Bart"},{"id":"TRY","name":"Turkish Lira"},{"id":"UGX","name":"Ugandan Shillings"},{"id":"UAH","name":"Ukrainian Hryvnia"},{"id":"UYU","name":"Uruguay Peso"},{"id":"USD","name":"US Dollar"},{"id":"VND","name":"Vietnamese Dong"},{"id":"HUF","name":"Hungary Florint"},{"id":"ISK","name":"Iceland Krona"},{"id":"INR","name":"Indian Rupee"},{"id":"IDR","name":"Indonesian Rupiah"},{"id":"ILS","name":"Israel Shekel"},{"id":"JPY","name":"Japanese Yen"},{"id":"JOD","name":"Jordanian Dinar"},{"id":"KES","name":"Kenyan Shillings"},{"id":"LVL","name":"Latvian Lats"},{"id":"LTL","name":"Lithuanian Litas"},{"id":"MYR","name":"Malay Ringit"},{"id":"MXN","name":"Mex Peso"},{"id":"MAD","name":"Moroccan Dirham"},{"id":"NZD","name":"New Zealand $"},{"id":"NGN","name":"Nigerian Naira"},{"id":"NOK","name":"Norwegian Krona"},{"id":"PHP","name":"Philippine Peso"}];var moversTypes=[{id:ModelRealtimeMoversCnstns.sortTypes.TOP_PRICE_CHANGE,name:'Gainers and Decliners by Price Change'},{id:ModelRealtimeMoversCnstns.sortTypes.TOP_VOLUME,name:'Top Securities by Volume'},{id:ModelRealtimeMoversCnstns.sortTypes.TOP_TRADES,name:'Top Securities by Trades'}];var spRatings=[{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_ALL,name:'- All -'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_AAA,name:'AAA'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_AA_PLUS,name:'AA+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_AA,name:'AA'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_AA_MINUS,name:'AA-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_A_PLUS,name:'A+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_A,name:'A'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_A_MINUS,name:'A-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BBB_PLUS,name:'BBB+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BBB,name:'BBB'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BBB_MINUS,name:'BBB-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BB_PLUS,name:'BB+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BB,name:'BB'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_BB_MINUS,name:'BB-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_B_PLUS,name:'B+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_B,name:'B'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_B_MINUS,name:'B-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CCC_PLUS,name:'CCC+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CCC,name:'CCC'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CCC_MINUS,name:'CCC-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CC_PLUS,name:'CC+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CC,name:'CC'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_CC_MINUS,name:'CC-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_C_PLUS,name:'C+'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_C,name:'C'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_C_MINUS,name:'C-'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_D,name:'D'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_NR,name:'NR'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_WR,name:'WR'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_SD,name:'SD'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_AVERAGE,name:'AVERAGE'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_STRONG,name:'STRONG'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_UR,name:'UR'},{id:ModelRealtimeMoversCnstns.ratingTypes.RATING_NA,name:'NA'}];var maturityIdsMap={};var maturityNamesMap={};var spRatingNamesMap={};var currenciesNamesMap={};var sectorIdsMap={};var sectorNamesMap={};var spRatingIdsMap={};var currenciesIdsMap={};var availableCurrencyIds=[];allCurrencies=$filter('orderBy')(allCurrencies,'name');mapItems(currenciesIdsMap,spRatingNamesMap,allCurrencies);$rootScope.$watch('controlsContent',function(data){if(data){processContentData(data);}});function processContentData(data){result.sectors=result.sectors.concat(data.sectors);result.allCurrencies=$filter('orderBy')(data.currencies,'name');mapItems(currenciesIdsMap,spRatingNamesMap,result.allCurrencies);notifier.publish('allCurrenciesChanged');angular.forEach(data.watchLists,function(watchList){watchList.id=ModelRealtimeMoversCnstns.listPrefixes.WATCH_LIST_PREFIX+watchList.id;watchList.group='Watchlists';});angular.forEach(data.portfolios,function(portfolio){portfolio.id=ModelRealtimeMoversCnstns.listPrefixes.PORTFOLIO_PREFIX+portfolio.id;portfolio.group='Portfolios';});result.maturityTypes=result.maturityTypes.concat(data.maturities);result.assetTypes=result.assetTypes.concat(data.assetTypes);result.lists=result.lists.concat(data.portfolios,data.watchLists);mapItems(maturityIdsMap,maturityNamesMap,result.maturityTypes);mapItems(sectorIdsMap,sectorNamesMap,result.sectors);mapItems(spRatingIdsMap,spRatingNamesMap,result.spRatings);result.ready=true;}
function mapItems(containerIds,containerNames,items){angular.forEach(items,function(item){containerIds[item.id]=item;containerNames[item.name]=item;});}
function getItemName(container,itemId){var item=container[itemId];return item&&item.name||null;}
function maturityName(maturityId){if(!maturityId){return null;}
var result=[];angular.forEach(maturityId.split('|'),function(matId){var name=getItemName(maturityIdsMap,matId);if(name){result.push(name);}});return result.length===0?null:result.join('|');}
function sectorName(sectorId){return getItemName(sectorIdsMap,sectorId);}
function spRatingName(spRatingId){return getItemName(spRatingIdsMap,spRatingId);}
function currencyName(currencyId){return getItemName(currenciesIdsMap,currencyId);}
function getItemId(container,itemName){var item=container[itemName];return item&&item.id||null;}
function maturityId(maturityName){if(!maturityName){return null;}
var result=[];angular.forEach(maturityName.split('|'),function(matName){var id=getItemId(maturityNamesMap,matName);if(id){result.push(id);}});return result.length===0?null:result.join('|');}
function sectorId(sectorName){return getItemId(sectorNamesMap,sectorName);}
function spRatingId(spRatingName){return getItemId(spRatingNamesMap,spRatingName);}
function currencyId(currencyName){return getItemId(currenciesNamesMap,currencyName);}
function setAvailableCurrencyIds(ids){if(!angular.isArray(ids)){availableCurrencyIds='None';}else if(ids.length===0){availableCurrencyIds='All';}else{availableCurrencyIds=[];angular.forEach(ids,function(id){availableCurrencyIds[id]=true;});}
result.currenciesReady=availableCurrencyIds!=='None';notifier.publish('currenciesReady',result.currenciesReady);notifier.publish('availableCurrenciesChanged');}
function isCurrencyAvailable(currencyId){if(availableCurrencyIds==='None'){return false;}
if(availableCurrencyIds==='All'){return true;}
return!!availableCurrencyIds[currencyId];}
result={lists:lists,sectors:sectors,spRatings:spRatings,moversTypes:moversTypes,maturityTypes:maturityTypes,assetTypes:assetTypes,allCurrencies:allCurrencies,ready:false,getMaturityName:maturityName,getMaturityId:maturityId,getSectorName:sectorName,getSectorId:sectorId,getSpRatingName:spRatingName,getSpRatingId:spRatingId,currencyName:currencyName,currencyId:currencyId,setAvailableCurrencyIds:setAvailableCurrencyIds,isCurrencyAvailable:isCurrencyAvailable,subscribe:notifier.subscribe,currenciesReady:false};return result;}
angular.module('ModuleRealtime').service('MoversControlsSource',MoversControlsSource);;!function($){"use strict";if(typeof ko!=='undefined'&&ko.bindingHandlers&&!ko.bindingHandlers.multiselect){ko.bindingHandlers.multiselect={after:['options','value','selectedOptions','enable','disable'],init:function(element,valueAccessor,allBindings,viewModel,bindingContext){var $element=$(element);var config=ko.toJS(valueAccessor());$element.multiselect(config);if(allBindings.has('options')){var options=allBindings.get('options');if(ko.isObservable(options)){ko.computed({read:function(){options();setTimeout(function(){var ms=$element.data('multiselect');if(ms)
ms.updateOriginalOptions();$element.multiselect('rebuild');},1);},disposeWhenNodeIsRemoved:element});}}
if(allBindings.has('value')){var value=allBindings.get('value');if(ko.isObservable(value)){ko.computed({read:function(){value();setTimeout(function(){$element.multiselect('refresh');},1);},disposeWhenNodeIsRemoved:element}).extend({rateLimit:100,notifyWhenChangesStop:true});}}
if(allBindings.has('selectedOptions')){var selectedOptions=allBindings.get('selectedOptions');if(ko.isObservable(selectedOptions)){ko.computed({read:function(){selectedOptions();setTimeout(function(){$element.multiselect('refresh');},1);},disposeWhenNodeIsRemoved:element}).extend({rateLimit:100,notifyWhenChangesStop:true});}}
var setEnabled=function(enable){setTimeout(function(){if(enable)
$element.multiselect('enable');else
$element.multiselect('disable');});};if(allBindings.has('enable')){var enable=allBindings.get('enable');if(ko.isObservable(enable)){ko.computed({read:function(){setEnabled(enable());},disposeWhenNodeIsRemoved:element}).extend({rateLimit:100,notifyWhenChangesStop:true});}else{setEnabled(enable);}}
if(allBindings.has('disable')){var disable=allBindings.get('disable');if(ko.isObservable(disable)){ko.computed({read:function(){setEnabled(!disable());},disposeWhenNodeIsRemoved:element}).extend({rateLimit:100,notifyWhenChangesStop:true});}else{setEnabled(!disable);}}
ko.utils.domNodeDisposal.addDisposeCallback(element,function(){$element.multiselect('destroy');});},update:function(element,valueAccessor,allBindings,viewModel,bindingContext){var $element=$(element);var config=ko.toJS(valueAccessor());$element.multiselect('setOptions',config);$element.multiselect('rebuild');}};}
function forEach(array,callback){for(var index=0;index<array.length;++index){callback(array[index],index);}}
function Multiselect(select,options){this.$select=$(select);if(this.$select.attr("data-placeholder")){options.nonSelectedText=this.$select.data("placeholder");}
this.options=this.mergeOptions($.extend({},options,this.$select.data()));this.originalOptions=this.$select.clone()[0].options;this.query='';this.searchTimeout=null;this.lastToggledInput=null;this.options.multiple=this.$select.attr('multiple')==="multiple";this.options.onChange=$.proxy(this.options.onChange,this);this.options.onDropdownShow=$.proxy(this.options.onDropdownShow,this);this.options.onDropdownHide=$.proxy(this.options.onDropdownHide,this);this.options.onDropdownShown=$.proxy(this.options.onDropdownShown,this);this.options.onDropdownHidden=$.proxy(this.options.onDropdownHidden,this);this.options.onInitialized=$.proxy(this.options.onInitialized,this);this.buildContainer();this.buildButton();this.buildDropdown();this.buildSelectAll();this.buildDropdownOptions();this.buildFilter();this.updateButtonText();this.updateSelectAll(true);if(this.options.disableIfEmpty&&$('option',this.$select).length<=0){this.disable();}
this.$select.hide().after(this.$container);this.options.onInitialized(this.$select,this.$container);}
Multiselect.prototype={defaults:{buttonText:function(options,select){if(this.disabledText.length>0&&(this.disableIfEmpty||select.prop('disabled'))&&options.length==0){return this.disabledText;}
else if(options.length===0){return this.nonSelectedText;}
else if(this.allSelectedText&&options.length===$('option',$(select)).length&&$('option',$(select)).length!==1&&this.multiple){if(this.selectAllNumber){return this.allSelectedText+' ('+options.length+')';}
else{return this.allSelectedText;}}
else if(options.length>this.numberDisplayed){return options.length+' '+this.nSelectedText;}
else{var selected='';var delimiter=this.delimiterText;options.each(function(){var label=($(this).attr('label')!==undefined)?$(this).attr('label'):$(this).text();selected+=label+delimiter;});return selected.substr(0,selected.length-2);}},buttonTitle:function(options,select){if(options.length===0){return this.nonSelectedText;}
else{var selected='';var delimiter=this.delimiterText;options.each(function(){var label=($(this).attr('label')!==undefined)?$(this).attr('label'):$(this).text();selected+=label+delimiter;});return selected.substr(0,selected.length-2);}},optionLabel:function(element){return $(element).attr('label')||$(element).text();},optionClass:function(element){return $(element).attr('class')||'';},onChange:function(option,checked){},onDropdownShow:function(event){},onDropdownHide:function(event){},onDropdownShown:function(event){},onDropdownHidden:function(event){},onSelectAll:function(checked){},onInitialized:function($select,$container){},enableHTML:false,buttonClass:'btn btn-default',inheritClass:false,buttonWidth:'auto',buttonContainer:'<div class="btn-group" />',dropRight:false,dropUp:false,selectedClass:'active',maxHeight:false,checkboxName:false,includeSelectAllOption:false,includeSelectAllIfMoreThan:0,selectAllText:' Select all',selectAllValue:'multiselect-all',selectAllName:false,selectAllNumber:true,selectAllJustVisible:true,enableFiltering:false,enableCaseInsensitiveFiltering:false,enableFullValueFiltering:false,enableClickableOptGroups:false,enableCollapsibelOptGroups:false,filterPlaceholder:'Search',maxSelectableOptions:0,filterBehavior:'text',includeFilterClearBtn:true,preventInputChangeEvent:false,nonSelectedText:'None selected',nSelectedText:'selected',allSelectedText:'All selected',numberDisplayed:3,disableIfEmpty:false,disabledText:'',delimiterText:', ',templates:{button:'<button type="button" class="multiselect dropdown-toggle" data-toggle="dropdown"><span class="multiselect-selected-text"></span> <b class="caret"></b></button>',ul:'<ul class="multiselect-container dropdown-menu"></ul>',filter:'<li class="multiselect-item filter"><div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',filterClearBtn:'<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="glyphicon glyphicon-remove-circle"></i></button></span>',li:'<li><a tabindex="0"><label></label></a></li>',divider:'<li class="multiselect-item divider"></li>',liGroup:'<li class="multiselect-item multiselect-group"><label></label></li>'}},constructor:Multiselect,buildContainer:function(){this.$container=$(this.options.buttonContainer);this.$container.on('show.bs.dropdown',this.options.onDropdownShow);this.$container.on('hide.bs.dropdown',this.options.onDropdownHide);this.$container.on('shown.bs.dropdown',this.options.onDropdownShown);this.$container.on('hidden.bs.dropdown',this.options.onDropdownHidden);},buildButton:function(){this.$button=$(this.options.templates.button).addClass(this.options.buttonClass);if(this.$select.attr('class')&&this.options.inheritClass){this.$button.addClass(this.$select.attr('class'));}
if(this.$select.prop('disabled')){this.disable();}
else{this.enable();}
if(this.options.buttonWidth&&this.options.buttonWidth!=='auto'){this.$button.css({'width':this.options.buttonWidth,'overflow':'hidden','text-overflow':'ellipsis'});this.$container.css({'width':this.options.buttonWidth});}
var tabindex=this.$select.attr('tabindex');if(tabindex){this.$button.attr('tabindex',tabindex);}
this.$container.prepend(this.$button);},buildDropdown:function(){this.$ul=$(this.options.templates.ul);if(this.options.dropRight){this.$ul.addClass('pull-right');}
if(this.options.maxHeight){this.$ul.css({'max-height':this.options.maxHeight+'px','overflow-y':'auto','overflow-x':'hidden'});}
if(this.options.dropUp){var height=Math.min(this.options.maxHeight,$('option[data-role!="divider"]',this.$select).length*26+$('option[data-role="divider"]',this.$select).length*19+(this.options.includeSelectAllOption?26:0)+(this.options.enableFiltering||this.options.enableCaseInsensitiveFiltering?44:0));var moveCalc=height+34;this.$ul.css({'max-height':height+'px','overflow-y':'auto','overflow-x':'hidden','margin-top':"-"+moveCalc+'px'});}
this.$container.append(this.$ul);},buildDropdownOptions:function(){this.$select.children().each($.proxy(function(index,element){var $element=$(element);var tag=$element.prop('tagName').toLowerCase();if($element.prop('value')===this.options.selectAllValue){return;}
if(tag==='optgroup'){this.createOptgroup(element);}
else if(tag==='option'){if($element.data('role')==='divider'){this.createDivider();}
else{this.createOptionValue(element);}}},this));$('li input',this.$ul).on('change',$.proxy(function(event){var $target=$(event.target);var checked=$target.prop('checked')||false;var isSelectAllOption=$target.val()===this.options.selectAllValue;if(this.options.selectedClass){if(checked){$target.closest('li').addClass(this.options.selectedClass);}
else{$target.closest('li').removeClass(this.options.selectedClass);}}
var value=$target.val();var $option=this.getOptionByValue(value);var $optionsNotThis=$('option',this.$select).not($option);var $checkboxesNotThis=$('input',this.$container).not($target);if(isSelectAllOption){if(checked){this.selectAll(this.options.selectAllJustVisible);}
else{this.deselectAll(this.options.selectAllJustVisible);}}
else{if(checked){$option.prop('selected',true);if(this.options.multiple){$option.prop('selected',true);if(this.options.maxSelectableOptions>0){var $selectedOptions=$('li.'+this.options.selectedClass,this.$container);var $optionsNotSelected=$('li',this.$container).not($selectedOptions);if($selectedOptions.length===5){$($optionsNotSelected).attr('disabled',true);$($optionsNotSelected).find('input').attr('disabled',true);}}}
else{if(this.options.selectedClass){$($checkboxesNotThis).closest('li').removeClass(this.options.selectedClass);}
$($checkboxesNotThis).prop('checked',false);$optionsNotThis.prop('selected',false);this.$button.click();}
if(this.options.selectedClass==="active"){$optionsNotThis.closest("a").css("outline","");}}
else{$option.prop('selected',false);$($checkboxesNotThis).closest('li').removeAttr('disabled');$($checkboxesNotThis).removeAttr('disabled');}
this.options.onChange($option,checked);}
this.$select.change();this.updateButtonText();this.updateSelectAll();if(this.options.preventInputChangeEvent){return false;}},this));$('li a',this.$ul).on('mousedown',function(e){if(e.shiftKey){return false;}});$('li a',this.$ul).on('touchstart click',$.proxy(function(event){event.stopPropagation();var $target=$(event.target);if(event.shiftKey&&this.options.multiple){if($target.is("label")){event.preventDefault();$target=$target.find("input");$target.prop("checked",!$target.prop("checked"));}
var checked=$target.prop('checked')||false;if(this.lastToggledInput!==null&&this.lastToggledInput!==$target){var from=$target.closest("li").index();var to=this.lastToggledInput.closest("li").index();if(from>to){var tmp=to;to=from;from=tmp;}
++to;var range=this.$ul.find("li").slice(from,to).find("input");range.prop('checked',checked);if(this.options.selectedClass){range.closest('li').toggleClass(this.options.selectedClass,checked);}
for(var i=0,j=range.length;i<j;i++){var $checkbox=$(range[i]);var $option=this.getOptionByValue($checkbox.val());$option.prop('selected',checked);}}
$target.trigger("change");}
if($target.is("input")&&!$target.closest("li").is(".multiselect-item")){this.lastToggledInput=$target;}
$target.blur();},this));this.$container.off('keydown.multiselect').on('keydown.multiselect',$.proxy(function(event){if($('input[type="text"]',this.$container).is(':focus')){return;}
if(event.keyCode===9&&this.$container.hasClass('open')){this.$button.click();}
else{var $items=$(this.$container).find("li:not(.divider):not(.disabled) a").filter(":visible");if(!$items.length){return;}
var index=$items.index($items.filter(':focus'));if(event.keyCode===38&&index>0){index--;}
else if(event.keyCode===40&&index<$items.length-1){index++;}
else if(!~index){index=0;}
var $current=$items.eq(index);$current.focus();if(event.keyCode===32||event.keyCode===13){var $checkbox=$current.find('input');$checkbox.prop("checked",!$checkbox.prop("checked"));$checkbox.change();}
event.stopPropagation();event.preventDefault();}},this));if(this.options.enableClickableOptGroups&&this.options.multiple){$('li.multiselect-group',this.$ul).on('click',$.proxy(function(event){event.stopPropagation();console.log('test');var group=$(event.target).parent();var $options=group.nextUntil('li.multiselect-group');var $visibleOptions=$options.filter(":visible:not(.disabled)");var allChecked=true;var optionInputs=$visibleOptions.find('input');var values=[];optionInputs.each(function(){allChecked=allChecked&&$(this).prop('checked');values.push($(this).val());});if(!allChecked){this.select(values,false);}
else{this.deselect(values,false);}
this.options.onChange(optionInputs,!allChecked);},this));}
if(this.options.enableCollapsibleOptGroups&&this.options.multiple){$("li.multiselect-group input",this.$ul).off();$("li.multiselect-group",this.$ul).siblings().not("li.multiselect-group, li.multiselect-all",this.$ul).each(function(){$(this).toggleClass('hidden',true);});$("li.multiselect-group",this.$ul).on("click",$.proxy(function(group){group.stopPropagation();},this));$("li.multiselect-group > a > b",this.$ul).on("click",$.proxy(function(t){t.stopPropagation();var n=$(t.target).closest('li');var r=n.nextUntil("li.multiselect-group");var i=true;r.each(function(){i=i&&$(this).hasClass('hidden');});r.toggleClass('hidden',!i);},this));$("li.multiselect-group > a > input",this.$ul).on("change",$.proxy(function(t){t.stopPropagation();var n=$(t.target).closest('li');var r=n.nextUntil("li.multiselect-group",':not(.disabled)');var s=r.find("input");var i=true;s.each(function(){i=i&&$(this).prop("checked");});s.prop("checked",!i).trigger("change");},this));$('li.multiselect-group',this.$ul).each(function(){var r=$(this).nextUntil("li.multiselect-group",':not(.disabled)');var s=r.find("input");var i=true;s.each(function(){i=i&&$(this).prop("checked");});$(this).find('input').prop("checked",i);});$("li input",this.$ul).on("change",$.proxy(function(t){t.stopPropagation();var n=$(t.target).closest('li');var r1=n.prevUntil("li.multiselect-group",':not(.disabled)');var r2=n.nextUntil("li.multiselect-group",':not(.disabled)');var s1=r1.find("input");var s2=r2.find("input");var i=$(t.target).prop('checked');s1.each(function(){i=i&&$(this).prop("checked");});s2.each(function(){i=i&&$(this).prop("checked");});n.prevAll('.multiselect-group').find('input').prop('checked',i);},this));$("li.multiselect-all",this.$ul).css('background','#f3f3f3').css('border-bottom','1px solid #eaeaea');$("li.multiselect-group > a, li.multiselect-all > a > label.checkbox",this.$ul).css('padding','3px 20px 3px 35px');$("li.multiselect-group > a > input",this.$ul).css('margin','4px 0px 5px -20px');}},createOptionValue:function(element){var $element=$(element);if($element.is(':selected')){$element.prop('selected',true);}
var label=this.options.optionLabel(element);var classes=this.options.optionClass(element);var value=$element.val();var inputType=this.options.multiple?"checkbox":"radio";var $li=$(this.options.templates.li);var $label=$('label',$li);$label.addClass(inputType);$li.addClass(classes);if(this.options.enableHTML){$label.html(" "+label);}
else{$label.text(" "+label);}
var $checkbox=$('<input/>').attr('type',inputType);if(this.options.checkboxName){$checkbox.attr('name',this.options.checkboxName);}
$label.prepend($checkbox);var selected=$element.prop('selected')||false;$checkbox.val(value);if(value===this.options.selectAllValue){$li.addClass("multiselect-item multiselect-all");$checkbox.parent().parent().addClass('multiselect-all');}
$label.attr('title',$element.attr('title'));this.$ul.append($li);if($element.is(':disabled')){$checkbox.attr('disabled','disabled').prop('disabled',true).closest('a').attr("tabindex","-1").closest('li').addClass('disabled');}
$checkbox.prop('checked',selected);if(selected&&this.options.selectedClass){$checkbox.closest('li').addClass(this.options.selectedClass);}},createDivider:function(element){var $divider=$(this.options.templates.divider);this.$ul.append($divider);},createOptgroup:function(group){if(this.options.enableCollapsibleOptGroups&&this.options.multiple){var label=$(group).attr("label");var value=$(group).attr("value");var r=$('<li class="multiselect-item multiselect-group"><a href="javascript:void(0);"><input type="checkbox" value="'+value+'"/><b> '+label+'<b class="caret"></b></b></a></li>');if(this.options.enableClickableOptGroups){r.addClass("multiselect-group-clickable")}
this.$ul.append(r);if($(group).is(":disabled")){r.addClass("disabled")}
$("option",group).each($.proxy(function($,group){this.createOptionValue(group)},this))}
else{var groupName=$(group).prop('label');var $li=$(this.options.templates.liGroup);if(this.options.enableHTML){$('label',$li).html(groupName);}
else{$('label',$li).text(groupName);}
if(this.options.enableClickableOptGroups){$li.addClass('multiselect-group-clickable');}
this.$ul.append($li);if($(group).is(':disabled')){$li.addClass('disabled');}
$('option',group).each($.proxy(function(index,element){this.createOptionValue(element);},this));}},buildSelectAll:function(){if(typeof this.options.selectAllValue==='number'){this.options.selectAllValue=this.options.selectAllValue.toString();}
var alreadyHasSelectAll=this.hasSelectAll();if(!alreadyHasSelectAll&&this.options.includeSelectAllOption&&this.options.multiple&&$('option',this.$select).length>this.options.includeSelectAllIfMoreThan){if(this.options.includeSelectAllDivider){this.$ul.prepend($(this.options.templates.divider));}
var $li=$(this.options.templates.li);$('label',$li).addClass("checkbox");if(this.options.enableHTML){$('label',$li).html(" "+this.options.selectAllText);}
else{$('label',$li).text(" "+this.options.selectAllText);}
if(this.options.selectAllName){$('label',$li).prepend('<input type="checkbox" name="'+this.options.selectAllName+'" />');}
else{$('label',$li).prepend('<input type="checkbox" />');}
var $checkbox=$('input',$li);$checkbox.val(this.options.selectAllValue);$li.addClass("multiselect-item multiselect-all");$checkbox.parent().parent().addClass('multiselect-all');this.$ul.prepend($li);$checkbox.prop('checked',false);}},buildFilter:function(){if(this.options.enableFiltering||this.options.enableCaseInsensitiveFiltering){var enableFilterLength=Math.max(this.options.enableFiltering,this.options.enableCaseInsensitiveFiltering);if(this.$select.find('option').length>=enableFilterLength){this.$filter=$(this.options.templates.filter);$('input',this.$filter).attr('placeholder',this.options.filterPlaceholder);if(this.options.includeFilterClearBtn){var clearBtn=$(this.options.templates.filterClearBtn);clearBtn.on('click',$.proxy(function(event){clearTimeout(this.searchTimeout);this.$filter.find('.multiselect-search').val('');$('li',this.$ul).show().removeClass("filter-hidden");this.updateSelectAll();},this));this.$filter.find('.input-group').append(clearBtn);}
this.$ul.prepend(this.$filter);this.$filter.val(this.query).on('click',function(event){event.stopPropagation();}).on('input keydown',$.proxy(function(event){if(event.which===13){event.preventDefault();}
clearTimeout(this.searchTimeout);this.searchTimeout=this.asyncFunction($.proxy(function(){if(this.query!==event.target.value){this.query=event.target.value;var currentGroup,currentGroupVisible;$.each($('li',this.$ul),$.proxy(function(index,element){var value=$('input',element).length>0?$('input',element).val():"";var text=$('label',element).text();var filterCandidate='';if((this.options.filterBehavior==='text')){filterCandidate=text;}
else if((this.options.filterBehavior==='value')){filterCandidate=value;}
else if(this.options.filterBehavior==='both'){filterCandidate=text+'\n'+value;}
if(value!==this.options.selectAllValue&&text){var showElement=false;if(this.options.enableCaseInsensitiveFiltering){filterCandidate=filterCandidate.toLowerCase();this.query=this.query.toLowerCase();}
if(this.options.enableFullValueFiltering&&this.options.filterBehavior!=='both'){var valueToMatch=filterCandidate.trim().substring(0,this.query.length);if(this.query.indexOf(valueToMatch)>-1){showElement=true;}}
else if(filterCandidate.indexOf(this.query)>-1){showElement=true;}
$(element).toggle(showElement).toggleClass('filter-hidden',!showElement);if($(element).hasClass('multiselect-group')){currentGroup=element;currentGroupVisible=showElement;}
else{if(showElement){$(currentGroup).show().removeClass('filter-hidden');}
if(!showElement&&currentGroupVisible){$(element).show().removeClass('filter-hidden');}}}},this));}
this.updateSelectAll();},this),300,this);},this));}}},destroy:function(){this.$container.remove();this.$select.show();this.$select.data('multiselect',null);},refresh:function(){var inputs=$.map($('li input',this.$ul),$);$('option',this.$select).each($.proxy(function(index,element){var $elem=$(element);var value=$elem.val();var $input;for(var i=inputs.length;0<i--;){if(value!==($input=inputs[i]).val())
continue;if($elem.is(':selected')){$input.prop('checked',true);if(this.options.selectedClass){$input.closest('li').addClass(this.options.selectedClass);}}
else{$input.prop('checked',false);if(this.options.selectedClass){$input.closest('li').removeClass(this.options.selectedClass);}}
if($elem.is(":disabled")){$input.attr('disabled','disabled').prop('disabled',true).closest('li').addClass('disabled');}
else{$input.prop('disabled',false).closest('li').removeClass('disabled');}
break;}},this));this.updateButtonText();this.updateSelectAll();},select:function(selectValues,triggerOnChange){if(!$.isArray(selectValues)){selectValues=[selectValues];}
for(var i=0;i<selectValues.length;i++){var value=selectValues[i];if(value===null||value===undefined){continue;}
var $option=this.getOptionByValue(value);var $checkbox=this.getInputByValue(value);if($option===undefined||$checkbox===undefined){continue;}
if(!this.options.multiple){this.deselectAll(false);}
if(this.options.selectedClass){$checkbox.closest('li').addClass(this.options.selectedClass);}
$checkbox.prop('checked',true);$option.prop('selected',true);if(triggerOnChange){this.options.onChange($option,true);}}
this.updateButtonText();this.updateSelectAll();},clearSelection:function(){this.deselectAll(false);this.updateButtonText();this.updateSelectAll();},deselect:function(deselectValues,triggerOnChange){if(!$.isArray(deselectValues)){deselectValues=[deselectValues];}
for(var i=0;i<deselectValues.length;i++){var value=deselectValues[i];if(value===null||value===undefined){continue;}
var $option=this.getOptionByValue(value);var $checkbox=this.getInputByValue(value);if($option===undefined||$checkbox===undefined){continue;}
if(this.options.selectedClass){$checkbox.closest('li').removeClass(this.options.selectedClass);}
$checkbox.prop('checked',false);$option.prop('selected',false);if(triggerOnChange){this.options.onChange($option,false);}}
this.updateButtonText();this.updateSelectAll();},selectAll:function(justVisible,triggerOnSelectAll){justVisible=(this.options.enableCollapsibleOptGroups&&this.options.multiple)?false:justVisible;var justVisible=typeof justVisible==='undefined'?true:justVisible;var allCheckboxes=$("li input[type='checkbox']:enabled",this.$ul);var visibleCheckboxes=allCheckboxes.filter(":visible");var allCheckboxesCount=allCheckboxes.length;var visibleCheckboxesCount=visibleCheckboxes.length;if(justVisible){visibleCheckboxes.prop('checked',true);$("li:not(.divider):not(.disabled)",this.$ul).filter(":visible").addClass(this.options.selectedClass);}
else{allCheckboxes.prop('checked',true);$("li:not(.divider):not(.disabled)",this.$ul).addClass(this.options.selectedClass);}
if(allCheckboxesCount===visibleCheckboxesCount||justVisible===false){$("option:not([data-role='divider']):enabled",this.$select).prop('selected',true);}
else{var values=visibleCheckboxes.map(function(){return $(this).val();}).get();$("option:enabled",this.$select).filter(function(index){return $.inArray($(this).val(),values)!==-1;}).prop('selected',true);}
if(triggerOnSelectAll){this.options.onSelectAll();}},deselectAll:function(justVisible){justVisible=(this.options.enableCollapsibleOptGroups&&this.options.multiple)?false:justVisible;justVisible=typeof justVisible==='undefined'?true:justVisible;if(justVisible){var visibleCheckboxes=$("li input[type='checkbox']:not(:disabled)",this.$ul).filter(":visible");visibleCheckboxes.prop('checked',false);var values=visibleCheckboxes.map(function(){return $(this).val();}).get();$("option:enabled",this.$select).filter(function(index){return $.inArray($(this).val(),values)!==-1;}).prop('selected',false);if(this.options.selectedClass){$("li:not(.divider):not(.disabled)",this.$ul).filter(":visible").removeClass(this.options.selectedClass);}}
else{$("li input[type='checkbox']:enabled",this.$ul).prop('checked',false);$("option:enabled",this.$select).prop('selected',false);if(this.options.selectedClass){$("li:not(.divider):not(.disabled)",this.$ul).removeClass(this.options.selectedClass);}}},rebuild:function(){this.$ul.html('');this.options.multiple=this.$select.attr('multiple')==="multiple";this.buildSelectAll();this.buildDropdownOptions();this.buildFilter();this.updateButtonText();this.updateSelectAll(true);if(this.options.disableIfEmpty&&$('option',this.$select).length<=0){this.disable();}
else{this.enable();}
if(this.options.dropRight){this.$ul.addClass('pull-right');}},dataprovider:function(dataprovider){var groupCounter=0;var $select=this.$select.empty();$.each(dataprovider,function(index,option){var $tag;if($.isArray(option.children)){groupCounter++;$tag=$('<optgroup/>').attr({label:option.label||'Group '+groupCounter,disabled:!!option.disabled});forEach(option.children,function(subOption){$tag.append($('<option/>').attr({value:subOption.value,label:subOption.label||subOption.value,title:subOption.title,selected:!!subOption.selected,disabled:!!subOption.disabled}));});}
else{$tag=$('<option/>').attr({value:option.value,label:option.label||option.value,title:option.title,class:option.class,selected:!!option.selected,disabled:!!option.disabled});$tag.text(option.label||option.value);}
$select.append($tag);});this.rebuild();},enable:function(){this.$select.prop('disabled',false);this.$button.prop('disabled',false).removeClass('disabled');},disable:function(){this.$select.prop('disabled',true);this.$button.prop('disabled',true).addClass('disabled');},setOptions:function(options){this.options=this.mergeOptions(options);},mergeOptions:function(options){return $.extend(true,{},this.defaults,this.options,options);},hasSelectAll:function(){return $('li.multiselect-all',this.$ul).length>0;},updateSelectAll:function(notTriggerOnSelectAll){if(this.hasSelectAll()){var allBoxes=$("li:not(.multiselect-item):not(.filter-hidden) input:enabled",this.$ul);var allBoxesLength=allBoxes.length;var checkedBoxesLength=allBoxes.filter(":checked").length;var selectAllLi=$("li.multiselect-all",this.$ul);var selectAllInput=selectAllLi.find("input");if(checkedBoxesLength>0&&checkedBoxesLength===allBoxesLength){selectAllInput.prop("checked",true);selectAllLi.addClass(this.options.selectedClass);this.options.onSelectAll(true);}
else{selectAllInput.prop("checked",false);selectAllLi.removeClass(this.options.selectedClass);if(checkedBoxesLength===0){if(!notTriggerOnSelectAll){this.options.onSelectAll(false);}}}}},updateButtonText:function(){var options=this.getSelected();if(this.options.enableHTML){$('.multiselect .multiselect-selected-text',this.$container).html(this.options.buttonText(options,this.$select));}
else{$('.multiselect .multiselect-selected-text',this.$container).text(this.options.buttonText(options,this.$select));}
$('.multiselect',this.$container).attr('title',this.options.buttonTitle(options,this.$select));},getSelected:function(){return $('option',this.$select).filter(":selected");},getOptionByValue:function(value){var options=$('option',this.$select);var valueToCompare=value.toString();for(var i=0;i<options.length;i=i+1){var option=options[i];if(option.value===valueToCompare){return $(option);}}},getInputByValue:function(value){var checkboxes=$('li input',this.$ul);var valueToCompare=value.toString();for(var i=0;i<checkboxes.length;i=i+1){var checkbox=checkboxes[i];if(checkbox.value===valueToCompare){return $(checkbox);}}},updateOriginalOptions:function(){this.originalOptions=this.$select.clone()[0].options;},asyncFunction:function(callback,timeout,self){var args=Array.prototype.slice.call(arguments,3);return setTimeout(function(){callback.apply(self||window,args);},timeout);},setAllSelectedText:function(allSelectedText){this.options.allSelectedText=allSelectedText;this.updateButtonText();}};$.fn.multiselect=function(option,parameter,extraOptions){return this.each(function(){var data=$(this).data('multiselect');var options=typeof option==='object'&&option;if(!data){data=new Multiselect(this,options);$(this).data('multiselect',data);}
if(typeof option==='string'){data[option](parameter,extraOptions);if(option==='destroy'){$(this).data('multiselect',false);}}});};$.fn.multiselect.Constructor=Multiselect;$(function(){$("select[data-role=multiselect]").multiselect();});}(window.jQuery);;var moversDownloadHtml='<form enctype="multipart/form-data" action="/movers/download" method="POST">'+'<input type="hidden" name="content" id="movers-download-content" />'+'<button class="btn btn-default btn-xs" title="Download">'+'<i class="fa fa-download icon-white"></i> <span>Download</span>'+'</button>'+'<input type="submit" id="movers-download-submit" style="display: none" />'+'</form>';function DirectiveRealtimeMoversDownload(jsonFilter){return{restrict:'C',template:moversDownloadHtml,link:function(scope,element){function getGridContent(){var result={moversType:$('#movers-mode span').text(),assetType:$('#movers-asset-type option:selected').text(),universe:$('#movers-list option:selected').text(),sector:$('#movers-sector option:selected').text(),rating:$('#movers-rating option:selected').text(),maturity:$('#movers-maturity').attr('selected-options'),grid:[]};var columns=['row','maturity','issuer','issue','identifier','current','px_chg','time','lt_price','lt_size','lt_type','lt_time','count','volume','rating','sector'];var gridContainer=$('.DirectiveRealtimeMoversGrid .ui-jqgrid-bdiv').not('.frozen-bdiv');gridContainer.find('tr[role="row"].jqgrow').each(function(){var row={};var columnIndex=0;$(this).find('td').each(function(){$(this).find('a').each(function(){row[columns[columnIndex]+'_link']=this.href;});row[columns[columnIndex++]]=$(this).text();});if(!row.issuer){result.grid.push({header:row.row});}else{result.grid.push(row);}});return result;}
$(element).find('button').click(function(){$(element).find('#movers-download-content').val(jsonFilter(getGridContent()));$(element).find('#movers-download-submit').click();return false;});}};}
angular.module('ModuleRealtime').directive('DirectiveRealtimeMoversDownload',DirectiveRealtimeMoversDownload);